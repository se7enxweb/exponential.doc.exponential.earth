<!DOCTYPE html>
<html>

<!-- Mirrored from doc.ez.no/display/EZP/Context+aware+HTTP+cache?showChildren=true by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 11:11:11 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
    <title>Context aware HTTP cache - Exponential 5.x - eZ Documentation</title>

        

                        
    
                        
    
                        
    

    <meta http-equiv="X-UA-Compatible" content="IE=EDGE,chrome=IE7">
<meta charset="UTF-8">
<meta id="confluence-context-path" name="confluence-context-path" content="">
<meta id="confluence-base-url" name="confluence-base-url" content="../../index.html">

<meta id="atlassian-token" name="atlassian-token" content="9996d8127abd36d1b757536de859090f8b455d10">


<meta id="confluence-space-key" name="confluence-space-key" content="EZP">
<script type="text/javascript">
        var contextPath = '';
</script>

    

    <meta name="confluence-request-time" content="1485859201741">
        
    
        
            <meta name="ajs-is-space-admin" content=""> <meta name="ajs-has-space-config" content="">
            <meta name="ajs-use-keyboard-shortcuts" content="true">
            <meta name="ajs-discovered-plugin-features" content="$discoveredList">
            <meta name="stp-license-product-name" content="Confluence"/> <meta name="stp-license-days-to-expiry" content="807"/> <meta name="stp-license-is-admin" content="false"/> <meta name="stp-license-should-keep-banner-hidden" content="true"/>
            <meta name="ajs-keyboardshortcut-hash" content="206314443b3cf79696d4ad89324a059c">
            <meta id="team-calendars-has-jira-link" content="true">
            <meta name="ajs-team-calendars-display-time-format" content="displayTimeFormat12">
            <meta id="team-calendars-user-timezone" content="UTC">
            <script type="text/x-template" id="team-calendars-messages" title="team-calendars-messages"><fieldset class="i18n hidden"><input type="hidden" name="calendar3.month.long.july" value="July"><input type="hidden" name="calendar3.day.short.wednesday" value="Wed"><input type="hidden" name="calendar3.day.short.thursday" value="Thu"><input type="hidden" name="calendar3.month.short.march" value="Mar"><input type="hidden" name="calendar3.month.long.april" value="April"><input type="hidden" name="calendar3.month.long.october" value="October"><input type="hidden" name="calendar3.month.long.august" value="August"><input type="hidden" name="calendar3.month.short.july" value="Jul"><input type="hidden" name="calendar3.month.short.may" value="May"><input type="hidden" name="calendar3.month.short.november" value="Nov"><input type="hidden" name="calendar3.day.long.friday" value="Friday"><input type="hidden" name="calendar3.day.long.sunday" value="Sunday"><input type="hidden" name="calendar3.day.long.saturday" value="Saturday"><input type="hidden" name="calendar3.month.short.april" value="Apr"><input type="hidden" name="calendar3.day.long.wednesday" value="Wednesday"><input type="hidden" name="calendar3.month.long.december" value="December"><input type="hidden" name="calendar3.month.short.october" value="Oct"><input type="hidden" name="calendar3.day.long.monday" value="Monday"><input type="hidden" name="calendar3.month.short.june" value="Jun"><input type="hidden" name="calendar3.day.short.monday" value="Mon"><input type="hidden" name="calendar3.day.short.tuesday" value="Tue"><input type="hidden" name="calendar3.day.short.saturday" value="Sat"><input type="hidden" name="calendar3.month.long.march" value="March"><input type="hidden" name="calendar3.month.long.june" value="June"><input type="hidden" name="calendar3.month.short.february" value="Feb"><input type="hidden" name="calendar3.month.short.august" value="Aug"><input type="hidden" name="calendar3.month.short.december" value="Dec"><input type="hidden" name="calendar3.day.short.sunday" value="Sun"><input type="hidden" name="calendar3.month.long.february" value="February"><input type="hidden" name="calendar3.day.long.tuesday" value="Tuesday"><input type="hidden" name="calendar3.month.long.may" value="May"><input type="hidden" name="calendar3.month.long.september" value="September"><input type="hidden" name="calendar3.month.long.november" value="November"><input type="hidden" name="calendar3.month.short.january" value="Jan"><input type="hidden" name="calendar3.month.short.september" value="Sep"><input type="hidden" name="calendar3.day.long.thursday" value="Thursday"><input type="hidden" name="calendar3.month.long.january" value="January"><input type="hidden" name="calendar3.day.short.friday" value="Fri"></fieldset></script>
            <meta name="ajs-is-confluence-admin" content="false">
            <meta name="ajs-connection-timeout" content="10000">
            
    
    
            <meta name="ajs-page-id" content="14712846">
            <meta name="ajs-latest-page-id" content="14712846">
            <meta name="ajs-content-type" content="page">
            <meta name="ajs-page-title" content="Context aware HTTP cache">
            <meta name="ajs-parent-page-title" content="Cache">
            <meta name="ajs-parent-page-id" content="6291890">
            <meta name="ajs-space-key" content="EZP">
            <meta name="ajs-space-name" content="Exponential 5.x">
            <meta name="ajs-from-page-title" content="">
            <meta name="ajs-can-remove-page" content="false">
            <meta name="ajs-context-path" content="">
            <meta name="ajs-base-url" content="https://doc.ez.no">
            <meta name="ajs-version-number" content="5.8.5">
            <meta name="ajs-build-number" content="5983">
            <meta name="ajs-remote-user" content="">
            <meta name="ajs-remote-user-key" content="">
            <meta name="ajs-current-user-fullname" content="">
            <meta name="ajs-current-user-avatar-url" content="">
            <meta name="ajs-static-resource-url-prefix" content="/s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_">
            <meta name="ajs-global-settings-attachment-max-size" content="10485760">
            <meta name="ajs-user-locale" content="en_GB">
            <meta name="ajs-enabled-dark-features" content="confluence-inline-comments-resolved,notification.plugin.api.enabled.com.atlassian.confluence.plugins.sharepage.api.ShareContentEvent,notification.plugin.api.enabled.com.atlassian.confluence.plugins.mentions.api.ConfluenceMentionEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.security.ForgotPasswordEvent,pdf-preview,notification.plugin.api.enabled.com.atlassian.confluence.plugins.tasklist.event.SendTaskEmailEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.page.async.PageMovedEvent,previews.sharing,previews.versions,notification.plugin.api.enabled.com.atlassian.confluence.plugins.files.notifications.event.FileContentUpdateEvent,file-annotations,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.attachment.AttachmentBatchUploadCompletedEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.comment.CommentCreateEvent,notification.plugin.api.enabled.com.atlassian.confluence.efi.emails.events.OnboardingLessUsersEvent,notification.plugin.api.enabled.com.atlassian.confluence.plugins.files.notifications.event.FileContentRemoveEvent,atlassian.aui.raphael.disabled,previews.conversion-service,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.comment.CommentUpdateEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.follow.FollowEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.page.async.PageEditedEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.blogpost.BlogPostCreateEvent,previews.trigger-all-file-types,notification.plugin.api.enabled.com.atlassian.confluence.plugins.inlinecomments.events.InlineCommentResolveEvent,notification.plugin.api.enabled.com.atlassian.confluence.event.events.like.LikeCreatedEvent,notification.plugin.api.enabled.com.atlassian.confluence.plugins.inlinecomments.events.InlineCommentCreateEvent,previews.sharing.pushstate,confluence-inline-comments-rich-editor,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.blogpost.BlogPostUpdateEvent,file-annotations.likes,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.page.async.PageCreatedEvent,notification.plugin.api.enabled.com.atlassian.confluence.plugins.files.notifications.event.FileContentMentionUpdateEvent,notification.plugin.api.enabled.com.atlassian.confluence.efi.emails.events.OnboardingNoSpaceCreatedEvent,notification.plugin.api.enabled.com.atlassian.confluence.plugins.hipchat.api.events.HipChatUserMapped,notification.plugin.api.enabled.com.atlassian.confluence.plugins.sharepage.api.ShareAttachmentEvent,confluence-inline-comments,confluence-inline-comments-dangling-comment,notification.plugin.api.enabled.com.atlassian.confluence.event.events.content.blogpost.BlogPostMovedEvent">
            <meta name="ajs-atl-token" content="9996d8127abd36d1b757536de859090f8b455d10">
            <meta name="ajs-confluence-flavour" content="VANILLA">
            <meta name="ajs-user-date-pattern" content="dd MMM yyyy">
            <meta name="ajs-date.format" content="MMM dd, yyyy">
    
    <link rel="shortcut icon" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/favicon.ico">
    <link rel="icon" type="image/x-icon" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/favicon.ico">

<link rel="search" type="application/opensearchdescription+xml" href="../../opensearch/osd.action" title="eZ Documentation"/>

<script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-nps-plugin:atlassian-nps-plugin-resources.is-server-instance-data-provider"]="true";
WRM._unparsedData["com.atlassian.plugins.browser.metrics.browser-metrics-plugin:browser-metrics.feature-data-provider-legacy"]="true";
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-rest:web-resource-manager.resource-base-url-pattern"]="\"(?:(?:/s/.*?/_)?/download)\"";
WRM._unparsedData["com.atlassian.confluence.plugins.confluence-license-banner:confluence-license-banner-resources.license-details"]="{\"daysBeforeLicenseExpiry\":0,\"daysBeforeMaintenanceExpiry\":0,\"showLicenseExpiryBanner\":false,\"showMaintenanceExpiryBanner\":false,\"renewUrl\":null,\"salesEmail\":null}";
WRM._unparsedData["com.atlassian.confluence.plugins.confluence-hipchat-integration-plugin:discovery-javascript-data.link-active"]="{\"linkActive\":false,\"conditionsMet\":true,\"admin\":false}";
WRM._unparsedData["com.atlassian.plugins.atlassian-nps-plugin:nps-acknowledgement-resources.analytics-enabled-data-provider"]="\"false\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-nps-plugin:nps-acknowledgement-resources.sen-data-provider"]="\"SEN-2255945\"";
WRM._unparsedData["com.atlassian.confluence.plugins.confluence-feature-discovery-plugin:confluence-feature-discovery-plugin-resources.test-mode"]="false";
WRM._unparsedData["com.atlassian.plugins.browser.metrics.browser-metrics-plugin:api.feature-data-provider"]="true";
</script>
<link type="text/css" rel="stylesheet" href="../../s/1b9968ac17721e3a6947d14e3a43c3f8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch9c16.css?build-number=5983" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/fcf875d0c4710a8c828036f5c6fb7fa5-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/b8d35340d2d85de2791f14a4692ecf7b/_/download/contextbatch/css/atl.confluence.plugins.pagetree-desktop%2cmain%2cvi/batchd6a4.css?highlightactions=true&amp;flavour=VANILLA&amp;locale=en-GB" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/6c0981174e94142364564819dc0d1413-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/b8d35340d2d85de2791f14a4692ecf7b/_/download/contextbatch/css/atl.confluence.plugins.pagetree-desktop,main,viewcontent,atl.general,page,atl.comments/batch.css?conditionalComment=lt+IE+9&amp;locale=en-GB" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/7893b9affdc3bf828ad93d0610d3d5f3-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/b8d35340d2d85de2791f14a4692ecf7b/_/download/contextbatch/css/atl.confluence.plugins.pagetree-desktop,main,viewcontent,atl.general,page,atl.comments/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/3a21f7b21af4c67045d1e0255f2ac570/_/download/contextbatch/css/theme.doc/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/3.7.2/_/download/batch/confluence.extra.information_information-plugin/confluence.extra.information_information-plugin-adg-styles.cc" media="all">
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/2.8.6/_/download/batch/org.randombits.confluence.toc_toc-plugin-styles/org.randombits.confluence.toc_toc-plugin-styles.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/2.1.7/_/download/batch/com.atlassian.confluence.ext.newcode-macro-plug/com.atlassian.confluence.ext.newcode-macro-plugin_syntaxhighl" media="all">
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/2.1.7/_/download/batch/com.atlassian.confluence.ext.newcode-macro-plug/com.atlassian.confluence.ext.newcode-macro-plugin_sh-theme-ec" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/51/_/styles/colorsb538.css?spaceKey=EZP" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/51/_/styles/customb538.css?spaceKey=EZP" media="all">
<script type="text/javascript" src="../../s/1f7b22082ef39a4bb134622dae929bdc-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/js/batch32f4.js?atlassian.aui.raphael.disabled=true&amp;locale=en-GB&amp;build-number=5983" ></script>
<script type="text/javascript" src="../../s/aa56759c03dcb293b394c4b46058625c-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/b8d35340d2d85de2791f14a4692ecf7b/_/download/contextbatch/js/atl.confluence.plugins.pagetree-desktop%2cmain%2cvi/batcha41c.js?highlightactions=true&amp;flavour=VANILLA&amp;locale=en-GB&amp;anonymous-access-enabled=true&amp;is-server-instance=true&amp;hostenabled=true" ></script>
<script type="text/javascript" src="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/2.8.6/_/download/batch/org.randombits.confluence.toc_client-side-toc-r/org.randombits.confluence.toc_client-side-toc-resources.cf.de" ></script>
<script type="text/javascript" src="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/2.8.6/_/download/batch/org.randombits.confluence.toc_toc-plugin-analytics/org.randombits.confluence.toc_toc-plugin-analytics.js" ></script>
<script type="text/javascript" src="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/2.1.7/_/download/batch/com.atlassian.confluence.ext.newcode-macro-plug/com.atlassian.confluence.ext-2.newcode-macro-plugin_syntaxhighl" ></script>
<script type="text/javascript" src="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/2.1.7/_/download/batch/com.atlassian.confluence.ext.newcode-macro-plug/com.atlassian.confluence.ext-3.newcode-macro-plugin_syntaxhighl" ></script>
<script type="text/javascript" src="../../s/6c0981174e94142364564819dc0d1413-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/2.1.7/_/download/batch/com.atlassian.confluence.ext.newcode-macro-plug/com.atlassian.confluence.ext.newcode-macro-plugin_syntaxhighl?locale=en-GB" ></script>


        
            <meta name="stp-license-product-name" content="Confluence"/> <meta name="stp-license-days-to-expiry" content="807"/> <meta name="stp-license-is-admin" content="false"/> <meta name="stp-license-should-keep-banner-hidden" content="true"/>
    

        
        <meta name="ajs-site-title" content="eZ Documentation" />

    
    

    
                <link rel="canonical" href="Context%2baware%2bHTTP%2bcache.html">
        <link rel="shortlink" href="Context%2baware%2bHTTP%2bcache.html">
    <meta name="wikilink" content="[EZP:Context aware HTTP cache]">
    <meta name="page-version" content="33">

</head>

<body             onload="placeFocus()"
     id="com-atlassian-confluence" class="theme-documentation  aui-theme-default aui-layout">

        
            <div id='stp-licenseStatus-banner'></div>
    <div id="full-height-container">
    <div id="header-precursor">
        
                    </div>






<header id="header" role="banner">
    <nav class="aui-header aui-dropdown2-trigger-group" role="navigation"><div class="aui-header-inner"><div class="aui-header-before"><a class=" aui-dropdown2-trigger app-switcher-trigger" aria-owns="app-switcher" aria-controls="app-switcher" aria-haspopup="true" data-aui-trigger href="#app-switcher"><span class="aui-icon aui-icon-small aui-iconfont-appswitcher">Linked Applications</span></a><div id="app-switcher" class="aui-dropdown2 aui-style-default"><div class="app-switcher-loading">Loading&hellip;</div></div><script>
            (function (NL) {
                var initialise = function () {
                    // For some milestones of AUI, the atlassian soy namespace was renamed to aui. Handle that here by ensuring that window.atlassian is defined.
                    window.atlassian = window.atlassian || window.aui;
                    new NL.AppSwitcher({
                        dropdownContents: '#app-switcher'
                    });
                };
                if (NL.AppSwitcher) {
                    initialise();
                } else {
                    NL.onInit = initialise;
                }
            }(window.NL = (window.NL || {})));
            window.NL.isUserAdmin = false</script></div><div class="aui-header-primary"><h1 id="logo" class="aui-header-logo aui-header-logo-custom"><a href="../../index.html"><img src="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/logo/atl.site.logo" alt="eZ Documentation" /></a></h1><ul class="aui-nav">
                            <li>
            
        
        
<a  id="space-directory-link" href="../../spacedirectory/view.html"  class=" aui-nav-imagelink"   title="Spaces">
            <span>Spaces</span>
    </a>
        </li>
                            <li id="browseMenu" role="menu">
            
    
        <a id="browse-menu-link" class="aui-nav-link aui-dropdown2-trigger" href="#" aria-haspopup="true" aria-owns="browse-menu-link-content" title="Browse">
        <span class="browse">Browse</span>
    </a>
    <nav id="browse-menu-link-content" class="aui-dropdown2 aui-style-default" aria-hidden="true">
                    <div class="aui-dropdown2-section">
                                <ul  id="browse-menu-link-leading" class="aui-list-truncate section-leading first">
                                            <li>
    
            
<a  id="space-pages-link" href="../../pages/listpages-dirview4915.html?key=EZP" class="    "      title="Browse pages in the Exponential 5.x space" >
        Pages
</a>
</li>
                                            <li>
    
            
<a  id="space-blogposts-link" href="../../pages/viewrecentblogposts4915.html?key=EZP" class="    "      title="Browse blogs in the Exponential 5.x space" >
        Blog
</a>
</li>
                                            <li>
    
            
<a  id="space-labels-link" href="../../labels/listlabels-heatmap4915.html?key=EZP" class="    "      title="Browse labels in the Exponential 5.x space" >
        Labels
</a>
</li>
                                            <li>
    
            
<a  id="space-advanced-link" href="../../spaces/viewspacesummary4915.html?key=EZP" class="    "      title="Browse additional space functions in the Exponential 5.x space" >
        Space Operations
</a>
</li>
                                    </ul>
            </div>
            </nav>
    
        </li>
        </ul>
</div><div class="aui-header-secondary"><ul class="aui-nav">
            <li>
        
    
            
<a  id="doctheme-anchor" href="#"  class=" aui-nav-imagelink"   title="">
            <span></span>
    </a>
    </li>
                    <li>
        <form id="quick-search" class="aui-quicksearch dont-default-focus header-quicksearch" action="https://doc.ez.no/dosearchsite.action" method="get"><fieldset><input type="hidden" name="where" value="EZP"/><input type="hidden" name="spaceSearch" value="true"/><label for="quick-search-query" class="assistive">Quick Search</label><input id="quick-search-query" class="text app-search search quick-search-query" type="text" accessKey="q" autocomplete="off" name="queryString" title="Quick Search" placeholder="Search space" /><input id="quick-search-submit" class="quick-search-submit" type="submit" value="Search"/><div class="aui-dd-parent quick-nav-drop-down"></div></fieldset></form>
    </li>
        <li>
            
        <a id="help-menu-link" class="aui-nav-link aui-dropdown2-trigger" href="#" aria-haspopup="true" aria-owns="help-menu-link-content" title="Help">
        <span class="aui-icon aui-icon-small aui-iconfont-help">Help</span>
    </a>
    <nav id="help-menu-link-content" class="aui-dropdown2 aui-style-default" aria-hidden="true">
                    <div class="aui-dropdown2-section">
                                <ul  id="help-menu-link-leading" class="aui-list-truncate section-leading first">
                                            <li>
        
            
<a  id="confluence-help-link" href="https://docs.atlassian.com/confluence/docs-58/Getting+Help+And+Support" class="    "      title="Visit the Confluence documentation home"  target="_blank"
>
        Online Help
</a>
</li>
                                            <li>
    
                
<a  id="keyboard-shortcuts-link" href="#" class="    "      title="View available keyboard shortcuts" >
        Keyboard Shortcuts
</a>
</li>
                                            <li>
    
            
<a  id="feed-builder-link" href="../../dashboard/configurerssfeed.html" class="    "      title="Create your custom RSS feed." >
        Feed Builder
</a>
</li>
                                            <li>
    
            
<a  id="whats-new-menu-link" href="https://docs.atlassian.com/confluence/docs-58/whatsnew/iframe" class="    "      title="" >
        What’s new
</a>
</li>
                                            <li>
    
                
<a  id="gadget-directory-link" href="#" class="   user-item administration-link "      title="Browse gadgets provided by Confluence" >
        Available Gadgets
</a>
</li>
                                            <li>
    
            
<a  id="confluence-about-link" href="../../aboutconfluencepage.html" class="    "      title="Get more information about Confluence" >
        About Confluence
</a>
</li>
                                    </ul>
            </div>
            </nav>
    
    </li>
        <li>
                
    
    </li>
        <li>
            
    </li>
        <li>
                                            <li>
        
            
<a  id="login-link" href="../../login9a59.html?os_destination=%2Fdisplay%2FEZP%2FContext%2Baware%2BHTTP%2Bcache%3FshowChildren%3Dtrue" class="   user-item login-link "      title="" >
        Log in
</a>
</li>
                        
    </li>
    </ul>
</div></div><!-- .aui-header-inner--></nav><!-- .aui-header -->
    <br class="clear">
</header>

    <div id="splitter">
    <div id="splitter-sidebar"  class="padding-div" >
        
        <p>&nbsp;<br/>
<strong>Global navigation</strong></p>

<p>&nbsp;<font color="#999">&bull;</font>&nbsp; <a href="../MAIN/eZ%2bDocumentation%2bCenter.html">Documentation Center</a><br/>
&nbsp;<font color="#999">&bull;</font>&nbsp; <a href="../TECHDOC/eZ%2bTechnical%2bManual.html">eZ Studio &amp; eZ Platform</a><br/>
&nbsp; &nbsp;<font color="#999">&bull;</font>&nbsp; <a href="../USERGUIDE/eZ%2bUser%2bManual.html">User Manual</a><br/>
&nbsp; &nbsp;<font color="#999">&bull;</font>&nbsp; <a href="../TECHDOC/eZ%2bTechnical%2bManual.html">Technical Manual</a><br/>
&nbsp; &nbsp;<font color="#999">&bull;</font>&nbsp; <a href="../MAIN/Glossary.html" title="Glossary">Glossary</a><br/>
&nbsp;<font color="#999">&bull;</font>&nbsp; <a href="../../Exponential/index.html" class="external-link" rel="nofollow">Exponential 4.x / legacy</a></p>



<p>&nbsp;<br/>
<a href="eZ%2bPublish%2b5.html"><strong>Exponential (5.x)</strong></a></p>
    

                    
    


<div class="plugin_pagetree">

        
        
    <ul class="plugin_pagetree_children_list plugin_pagetree_children_list_noleftspace">
        <div class="plugin_pagetree_children">
        </div>
    </ul>

    <fieldset class="hidden">
        <input type="hidden" name="treeId" value="">
        <input type="hidden" name="treeRequestId" value="/plugins/pagetree/naturalchildren.action?decorator=none&amp;excerpt=false&amp;sort=position&amp;reverse=false&amp;disableLinks=false&amp;expandCurrent=false">
        <input type="hidden" name="treePageId" value="14712846">

        <input type="hidden" name="noRoot" value="false">
        <input type="hidden" name="rootPageId" value="1114149">

        <input type="hidden" name="rootPage" value="">
        <input type="hidden" name="startDepth" value="0">
        <input type="hidden" name="spaceKey" value="EZP" >

        <input type="hidden" name="i18n-pagetree.loading" value="Loading...">
        <input type="hidden" name="i18n-pagetree.error.permission" value="Unable to load page tree. It seems that you do not have permission to view the root page.">
        <input type="hidden" name="i18n-pagetree.eeror.general" value="There was a problem retrieving the page tree. Please check the server log file for more information.">
        <input type="hidden" name="loginUrl" value="/login.action?os_destination=%2Fpages%2Fviewpage.action%3FspaceKey%3DEZP%26title%3DContext%2Baware%2BHTTP%2Bcache%26showChildren%3Dtrue">
        <input type="hidden" name="mobile" value="false">

                <fieldset class="hidden">
                                                <input type="hidden" name="ancestorId" value="6291890">
                                    <input type="hidden" name="ancestorId" value="12781009">
                                    <input type="hidden" name="ancestorId" value="6291674">
                                    <input type="hidden" name="ancestorId" value="1114149">
                                    </fieldset>
    </fieldset>
</div>



            </div>
    <div id="splitter-content">

                    <script type="text/javascript" src="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5.8.5/_/download/resources/com.atlassian.confluence.plugins.doctheme_resources/doc-theme.js"></script>
    
                        
        <div id="theme-header">
            <div class="sectionColumnWrapper"><div class="sectionMacro">
<div class="sectionMacroRow"><div class="columnMacro"></div>
<div class="columnMacro">
<div class="panel" style="background-color: #F0F0F0;border-color: #999999;border-style: solid;border-width: 1px;"><div class="panelContent" style="background-color: #F0F0F0;">
<p><strong>Exponential 5.x</strong> | For <em>eZ Platform</em> &amp; <em>eZ Studio</em> topics see <a href="../DEVELOPER/Documentation.html">Technical manual</a> and <a href="../USER.html">User manual</a>, for <em>Exponential 4.x</em> and <em>Legacy</em> topics see <a href="../../Exponential/index.html" class="external-link" rel="nofollow">Exponential legacy</a></p>
</div></div></div><div class="columnMacro"></div></div></div></div>
        </div>
    
            
<div id="main"  class="aui-page-panel" >
    <div id="main-header">
        
        
    <div id="navigation" class="content-navigation view">
                    <ul class="ajs-menu-bar">
                                                        
                    
        <li class="normal ajs-menu-item">
        <a id="action-menu-link" class="action aui-dropdown2-trigger-arrowless aui-button aui-button-subtle ajs-menu-title aui-dropdown2-trigger" href="#" aria-haspopup="true" aria-owns="action-menu" data-container="#navigation">
            <span>
                                    <span class="aui-icon aui-icon-small aui-iconfont-more"></span>
                                
            </span>
        </a>         <div id="action-menu" class="aui-dropdown2 aui-style-default">
                            <ul  id="action-menu-primary"                     class="section-primary first aui-dropdown2-section">
                                            <li>

    
        
                                            
    
    
    <a  id="view-attachments-link" href="../../pages/viewpageattachmentsd750.html?pageId=14712846" rel="nofollow" class="action-view-attachments"  accessKey="t"  title="View Attachments">
                <span>
                        A<u>t</u>tachments (0)
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="action-view-history-link" href="../../pages/viewpreviousversionsd750.html?pageId=14712846" rel="nofollow" class="action-view-history"   title="">
                <span>
                        Page History
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="action-page-permissions-link" href="../../pages/viewinfod750.html?pageId=14712846" rel="nofollow" class="action-page-permissions"   title="Edit restrictions">
                <span>
                        Restrictions
        </span>    </a>
</li>
                                </ul>
                            <ul  id="action-menu-secondary"                     class="section-secondary aui-dropdown2-section">
                                            <li>

    
        
                                            
    
    
    <a  id="view-page-info-link" href="../../pages/viewinfod750.html?pageId=14712846" rel="nofollow" class="action-view-info"   title="">
                <span>
                        Page Information
        </span>    </a>
</li>
                                        <li>

    
            
                                            
    
    
    <a  id="view-resolved-comments" href="#" rel="nofollow" class=""   title="">
                <span>
                        Resolved comments
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="link-to-page-link" href="../../pages/viewinfod750.html?pageId=14712846" rel="nofollow" class=""   title="Link to this Page">
                <span>
                        Link to this Page…
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="view-in-hierarchy-link" href="../../pages/listpages-dirviewe335.html?key=EZP&amp;openId=14712846#selectedPageInHierarchy" rel="nofollow" class=""   title="">
                <span>
                        View in Hierarchy
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="action-view-source-link" href="../../plugins/viewsource/viewpagesrcd750.html?pageId=14712846" rel="nofollow" class="action-view-source popup-link"   title="">
                <span>
                        View Source
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="action-export-pdf-link" href="../../download/temp/pdfexport-20170131-310117-0952-3659/EZP-ContextawareHTTPcache-310117-0952-3660f1f7.pdf?pageId=14712846" rel="nofollow" class=""   title="">
                <span>
                        Export to PDF
        </span>    </a>
</li>
                                        <li>

    
        
                                            
    
    
    <a  id="action-export-word-link" href="../../exportwordd750?pageId=14712846" rel="nofollow" class="action-export-word"   title="">
                <span>
                        Export to Word
        </span>    </a>
</li>
                                </ul>
                    </div>
    </li>
            </ul>
    </div>

        
                <div id="title-heading" class="pagetitle with-breadcrumbs">
        
                            <div class="space-logo " data-key="EZP" data-name="Exponential 5.x" data-entity-type="confluence.space">
            <a><img class="logo space custom" src="../../download/attachments/1736738/EZPc728?version=5&amp;modificationDate=1434758205000&amp;api=v2" alt=""></a>
        </div>            
                            <div id="breadcrumb-section">
                    
    
    
    <ol id="breadcrumbs">
                                        
                        
        <li class="first" >
                        
                            <span class=""><a href="eZ%2bPublish%2b5.html">Exponential 5.x</a></span>
                                                                                            <li id="ellipsis" title="Show all breadcrumbs"><span><strong>&#8230;</strong></span></li>
                                                
                        
        <li class="hidden-crumb" >
                        
                            <span class=""><a href="eZ%2bPublish%2b5.html">Exponential 5.x Developer Documentation</a></span>
                                                                                    
                        
        <li class="hidden-crumb" >
                        
                            <span class=""><a href="../../pages/viewpage6ff2.html?pageId=6291674">Development &amp; Administration Guides</a></span>
                                                                                    
                        
        <li class="hidden-crumb" >
                        
                            <span class=""><a href="Features.html">Features</a></span>
                                                                    
                        
        <li>
                        
                            <span class=""><a href="Cache.html">Cache</a></span>
                                                    </ol>


                </div>
            
            <h1 id="title-text" class="with-breadcrumbs">
                                        <a href="Context%2baware%2bHTTP%2bcache.html">Context aware HTTP cache</a>
                            </h1>
        </div>
    </div>

    

    
    
    
    
    

        




        




    

    

    







    
    
        
    
    
                    
    

    


<div id="content" class="page view">
    


<div id="action-messages">
                        </div>



        <script type="text/x-template" title="searchResultsGrid">
    <table class="aui">
        <thead>
            <tr class="header">
                <th class="search-result-title">Page Title</th>
                <th class="search-result-space">Space</th>
                <th class="search-result-date">Updated</th>
            </tr>
        </thead>
    </table>
</script>
<script type="text/x-template" title="searchResultsGridCount">
    <p class="search-result-count">{0}</p>
</script>
<script type="text/x-template" title="searchResultsGridRow">
    <tr class="search-result">
        <td class="search-result-title"><a href="{1}" class="content-type-{2}"><span>{0}</span></a></td>
        <td class="search-result-space"><a class="space" href="/display/{4}/" title="{3}">{3}</a></td>
        <td class="search-result-date"><span class="date" title="{6}">{5}</span></td>
    </tr>
</script>
        
    
    
        <fieldset class="hidden parameters">
            <input type="hidden" title="parentPageId" value="6291890">
        </fieldset>

                            
    

                    

        
        <a href="#page-metadata-end" class="assistive">Skip to end of metadata</a>
<div id="page-metadata-start" class="assistive"></div>

    <div class="page-metadata">
        <ul>
                            <li class="page-metadata-item noprint">

    
            
                                            
    
    
    <a  id="content-metadata-page-restrictions" href="#" rel="nofollow" class="hidden"   title="Restrictions apply">
                    <img alt="" src="../../download/resources/com.atlassian.confluence.plugins.confluence-page-banner_page-banner-resources/images/red_padlock.png" height="16" width="16" title="">
                <span>
                        
        </span>    </a>
</li>
                        <li class="page-metadata-modification-info">
                
        
    
        
    
        
            
            Created by <span class='author'>     <a href="../../login2ed8.html"
                       class="url fn"
                            >Jérôme Vieilledent</a></span>, last modified by <span class='editor'>     <a href="../../loginee65.html"
                       class="url fn"
                            >Dominika Kurek</a></span> on <a class='last-modified' title='Show changes' href='../../pages/diffpagesbyversion073d.html?pageId=14712846&amp;selectedPageVersions=32&amp;selectedPageVersions=33'>Oct 05, 2016</a>
                </li>
        </ul>
    </div>


<a href="#page-metadata-start" class="assistive">Go to start of metadata</a>
<div id="page-metadata-end" class="assistive"></div>

        
        <fieldset class="hidden parameters">
                        <input type="hidden" title="browsePageTreeMode" value="view">
        </fieldset>

        <div id="main-content" class="wiki-content">
                           
        <div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>If you are looking for 5.2/5.3 Context aware HTTP cache, see the page <a href="Context%2baware%2bHTTP%2bcache%2bin%2beZ%2bPublish%2b5.2-5.html">Context aware HTTP cache in Exponential 5.2-5.3</a></p></div></div><p><div class="toc-macro client-side-toc-macro " data-headerelements="H1,H2,H3,H4,H5,H6,H7"></div></p><p>This feature is available as of <strong>Exponential 5.2</strong></p><h2 id="ContextawareHTTPcache-Usecase">Use case</h2><p>Being based on Symfony 2, Exponential 5 uses HTTP cache from version 5.0 <a href="Context%2baware%2bHTTP%2bcache.html">extended with content awareness</a>. However this cache management is only available for anonymous users due to HTTP restrictions.</p><p>It is of course possible to make HTTP cache vary thanks to the <code>Vary</code> response header, but this header can only be based on one of the request headers (e.g. <code>Accept-Encoding</code>). Thus, to make the cache vary on a specific context (e.g. a hash based on a user roles and limitations), this context must be present in the original request</p><h2 id="ContextawareHTTPcache-Feature">Feature</h2><p>As the response can vary on a request header, the base solution is to make the kernel do a sub-request in order to retrieve the user context hash (aka <strong>user hash</strong>). Once the <em>user hash</em> has been retrieved, it's injected in the original request in the <code>X-User-Hash</code> custom header, making it possible to <em>vary</em> the HTTP response on this header:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script type="syntaxhighlighter" class="brush: php; gutter: false; theme: Eclipse"><![CDATA[&lt;?php
use Symfony\Component\HttpFoundation\Response;

// ...

// Inside a controller action
$response = new Response();
$response-&gt;setVary(&#39;X-User-Hash&#39;);]]></script>
</div></div><p>This solution is implemented in Symfony reverse proxy (aka <em>HttpCache</em>) and is also accessible to dedicated reverse proxies like Varnish.</p><div class="confluence-information-macro confluence-information-macro-note"><span class="aui-icon aui-icon-small aui-iconfont-warning confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Note that sharing ESIs across SiteAccesses is not possible by design (see 
    <span class="jira-issue resolved" >
        <a href="https://jira.ez.no/browse/EZP-22535" class="jira-issue-key"><img class="icon" src="https://jira.ez.no/images/icons/issuetypes/bug.png" />EZP-22535</a>
                    -
            <span class="summary">Cached ESI can not be shared across pages/siteaccesses due to &quot;pathinfo&quot; property</span>
                <!-- The new status lozengens support for JIRA 6.2 or later. Otherwise we use the icon.-->
                                            <span class="aui-lozenge aui-lozenge-subtle aui-lozenge-success jira-macro-single-issue-export-pdf">Closed</span>
            </span>
 for technical details)</p></div></div><div class="confluence-information-macro confluence-information-macro-tip"><p class="title">Vary by User</p><span class="aui-icon aui-icon-small aui-iconfont-approve confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>In cases where you need to deliver content uniquely to a given user, and tricks like using javascript and cookie values, hinclude, or disabling cache is not an option. Then remaining option is to vary response by cookie:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script type="syntaxhighlighter" class="brush: php; gutter: false; theme: Eclipse"><![CDATA[$response-&gt;setVary(&#39;Cookie&#39;);]]></script>
</div></div><p>Unfortunately this is not optimal as it will by default vary by all cookies, including those set by add trackers, analytics tools, recommendation services, ... However as long as <em>your</em> application backend does not need these cookies, you can solve this by stripping everything but session cookie. Example for Varnish can be found in the default VCL examples in part dealing with User Hash, for single server setup this can easily be accomplished in Apache / Nginx as well.</p></div></div><p> </p><h2 id="ContextawareHTTPcache-Httpcacheclear">Http cache clear</h2><p><span class="status-macro aui-lozenge aui-lozenge-current">5.4</span> / <span class="status-macro aui-lozenge aui-lozenge-current">2014.11</span></p><p>As of v5.4 / v2014.11, usage of <a href="http://foshttpcachebundle.readthedocs.org/" class="external-link" rel="nofollow">FOSHttpCacheBundle</a> has been introduced, impacting the following features:</p><ul class="task-list"><li>Http cache purge</li><li>User context hash</li></ul><p>Varnish proxy client from FOSHttpCache lib is now used for clearing eZ Http cache, even when using Symfony HttpCache. A single <code>BAN</code> request is sent to registered purge servers, containing a <code>X-Location-Id</code> header. This header contains all Location IDs for which objects in cache need to be cleared.</p><h2 id="ContextawareHTTPcache-Symfonyreverseproxy">Symfony reverse proxy</h2><p>Symfony reverse proxy (aka HttpCache) is supported out of the box, all you have to do is to activate it.</p><h2 id="ContextawareHTTPcache-Varnish">Varnish</h2><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body">Please refer to <a href="../../login61f9.html?pageId=25985773">Using Varnish with Exponential Platform 5.4</a></div></div><h2 id="ContextawareHTTPcache-Usercontexthash">User context hash</h2><p><a href="http://foshttpcachebundle.readthedocs.org/en/latest/features/user-context.html" class="external-link" rel="nofollow">FOSHttpCacheBundle <em>User Context feature</em> is used</a> is activated by default.</p><p>As the response can vary on a request header, the base solution is to make the kernel do a sub-request in order to retrieve the context (aka <strong>user context hash</strong>). Once the <em>user hash</em> has been retrieved, it's injected in the original request in the <code>X-User-Hash</code> header, making it possible to <em>vary</em> the HTTP response on this header:</p><div class="confluence-information-macro confluence-information-macro-information"><span class="aui-icon aui-icon-small aui-iconfont-info confluence-information-macro-icon"></span><div class="confluence-information-macro-body">Name of the <a href="http://foshttpcachebundle.readthedocs.org/en/latest/reference/configuration/user-context.html" class="external-link" rel="nofollow">user hash header is configurable in FOSHttpCacheBundle</a>. By default Exponential sets it to <code>**X-User-Hash**</code>.</div></div><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script type="syntaxhighlighter" class="brush: php; gutter: false; theme: Eclipse"><![CDATA[&lt;?php 
use Symfony\Component\HttpFoundation\Response;
 
// ...
 
// Inside a controller action
$response = new Response();
$response-&gt;setVary( &#39;X-User-Hash&#39; );

]]></script>
</div></div><p> </p><p>This solution is <a href="http://foshttpcachebundle.readthedocs.org/en/latest/features/symfony-http-cache.html" class="external-link" rel="nofollow">implemented in Symfony reverse proxy (aka <em>HttpCache</em>)</a> and is also accessible to <a href="http://foshttpcache.readthedocs.org/en/latest/varnish-configuration.html" class="external-link" rel="nofollow">dedicated reverse proxies like Varnish</a>.</p><h2 id="ContextawareHTTPcache-Workflow">Workflow</h2><div class="confluence-information-macro confluence-information-macro-tip"><span class="aui-icon aui-icon-small aui-iconfont-approve confluence-information-macro-icon"></span><div class="confluence-information-macro-body">Please refer to <a href="http://foshttpcachebundle.readthedocs.org/en/latest/features/user-context.html#how-it-works" class="external-link" rel="nofollow">FOSHttpCacheBundle documentation on how user context feature works</a>.</div></div><h2 id="ContextawareHTTPcache-Userhashgeneration">User hash generation</h2><div class="confluence-information-macro confluence-information-macro-tip"><span class="aui-icon aui-icon-small aui-iconfont-approve confluence-information-macro-icon"></span><div class="confluence-information-macro-body">Please refer to <a href="http://foshttpcachebundle.readthedocs.org/en/latest/features/user-context.html#generating-hashes" class="external-link" rel="nofollow">FOSHttpCacheBundle documentation on how user hashes are being generated</a>.</div></div><p>Exponential already interferes in the hash generation process, by adding current user permissions and limitations. One can also interfere in this process by <a href="http://foshttpcachebundle.readthedocs.org/en/latest/reference/configuration/user-context.html#custom-context-providers" class="external-link" rel="nofollow">implementing custom context provider(s)</a>.</p><h3 id="ContextawareHTTPcache-UserhashgenerationwithVarnish3">User hash generation with Varnish 3</h3><p>Described behavior comes out of the box with Symfony reverse proxy, but it's of course possible ot use Varnish to achieve the same.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script type="syntaxhighlighter" class="brush: bash; gutter: false; theme: Eclipse"><![CDATA[# Varnish 3 style for Exponential 5.4 / 2014.11
# Our Backend - We assume that Exponential Web server listen on port 80 on the same machine.
backend exponential {
    .host = &quot;127.0.0.1&quot;;
    .port = &quot;80&quot;;
}

# Called at the beginning of a request, after the complete request has been received
sub vcl_recv {

    # Set the backend
    set req.backend = exponential;

    # ...

    # Retrieve client user hash and add it to the forwarded request.
    call ez_user_hash;

    # If it passes all these tests, do a lookup anyway;
    return (lookup);
}

# Sub-routine to get client user hash, for context-aware HTTP cache.
# Don&#39;t forget to correctly set the backend host for the Curl sub-request.
sub ez_user_hash {

    # Prevent tampering attacks on the hash mechanism
    if (req.restarts == 0
        &amp;&amp; (req.http.accept ~ &quot;application/vnd.fos.user-context-hash&quot;
            || req.http.x-user-context-hash
        )
    ) {
        error 400;
    }

    if (req.restarts == 0 &amp;&amp; (req.request == &quot;GET&quot; || req.request == &quot;HEAD&quot;)) {
        # Get User (Context) hash, for varying cache by what user has access to.
        # https://doc.ez.no/display/EZP/Context+aware+HTTP+cach

        # Anonymous user w/o session =&gt; Use hardcoded anonymous hash to avoid backend lookup for hash
        if (req.http.Cookie !~ &quot;eZSESSID&quot; &amp;&amp; !req.http.authorization) {
            # You may update this hash with the actual one for anonymous user
            # to get a better cache hit ratio across anonymous users.
            # Note: Then needs update every time anonymous user role assignments change.
            set req.http.X-User-Hash = &quot;38015b703d82206ebc01d17a39c727e5&quot;;
        }
        # Pre-authenticate request to get shared cache, even when authenticated
        else {
            set req.http.x-fos-original-url    = req.url;
            set req.http.x-fos-original-accept = req.http.accept;
            set req.http.x-fos-original-cookie = req.http.cookie;
            # Clean up cookie for the hash request to only keep session cookie, as hash cache will vary on cookie.
            set req.http.cookie = &quot;;&quot; + req.http.cookie;
            set req.http.cookie = regsuball(req.http.cookie, &quot;; +&quot;, &quot;;&quot;);
            set req.http.cookie = regsuball(req.http.cookie, &quot;;(eZSESSID[^=]*)=&quot;, &quot;; \1=&quot;);
            set req.http.cookie = regsuball(req.http.cookie, &quot;;[^ ][^;]*&quot;, &quot;&quot;);
            set req.http.cookie = regsuball(req.http.cookie, &quot;^[; ]+|[; ]+$&quot;, &quot;&quot;);

            set req.http.accept = &quot;application/vnd.fos.user-context-hash&quot;;
            set req.url = &quot;/_fos_user_context_hash&quot;;

            # Force the lookup, the backend must tell not to cache or vary on all
            # headers that are used to build the hash.

            return (lookup);
        }
    }

    # Rebuild the original request which now has the hash.
    if (req.restarts &gt; 0
        &amp;&amp; req.http.accept == &quot;application/vnd.fos.user-context-hash&quot;
    ) {
        set req.url         = req.http.x-fos-original-url;
        set req.http.accept = req.http.x-fos-original-accept;
        set req.http.cookie = req.http.x-fos-original-cookie;

        unset req.http.x-fos-original-url;
        unset req.http.x-fos-original-accept;
        unset req.http.x-fos-original-cookie;

        # Force the lookup, the backend must tell not to cache or vary on the
        # user hash to properly separate cached data.

        return (lookup);
    }
}

sub vcl_fetch {

    # ...

    if (req.restarts == 0
        &amp;&amp; req.http.accept ~ &quot;application/vnd.fos.user-context-hash&quot;
        &amp;&amp; beresp.status &gt;= 500
    ) {
        error 503 &quot;Hash error&quot;;
    }
}

sub vcl_deliver {
    # On receiving the hash response, copy the hash header to the original
    # request and restart.
    if (req.restarts == 0
        &amp;&amp; resp.http.content-type ~ &quot;application/vnd.fos.user-context-hash&quot;
        &amp;&amp; resp.status == 200
    ) {
        set req.http.x-user-hash = resp.http.x-user-hash;

        return (restart);
    }

    # If we get here, this is a real response that gets sent to the client.

    # Remove the vary on context user hash, this is nothing public. Keep all
    # other vary headers.
    set resp.http.Vary = regsub(resp.http.Vary, &quot;(?i),? *x-user-hash *&quot;, &quot;&quot;);
    set resp.http.Vary = regsub(resp.http.Vary, &quot;^, *&quot;, &quot;&quot;);
    if (resp.http.Vary == &quot;&quot;) {
        remove resp.http.Vary;
    }

    # Sanity check to prevent ever exposing the hash to a client.
    remove resp.http.x-user-hash;
}
]]></script>
</div></div><h3 id="ContextawareHTTPcache-UserhashgenerationwithVarnish4">User hash generation with Varnish 4</h3><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script type="syntaxhighlighter" class="brush: php; gutter: false; theme: Eclipse"><![CDATA[// Varnish 4 style - eZ 5.4+ / 2014.09+
// Complete VCL example

vcl 4.0;

// Our Backend - Assuming that web server is listening on port 80
// Replace the host to fit your setup
backend exponential {
    .host = &quot;127.0.0.1&quot;;
    .port = &quot;80&quot;;
}

// Called at the beginning of a request, after the complete request has been received
sub vcl_recv {

    // Set the backend
    set req.backend_hint = exponential;

    // ...

    // Retrieve client user hash and add it to the forwarded request.
    call ez_user_hash;

    // If it passes all these tests, do a lookup anyway.
    return (hash);
}
 
// Called when the requested object has been retrieved from the backend
sub vcl_backend_response {
    if (bereq.http.accept ~ &quot;application/vnd.fos.user-context-hash&quot;
        &amp;&amp; beresp.status &gt;= 500
    ) {
        return (abandon);
    }
    
    // ...
}

// Sub-routine to get client user hash, for context-aware HTTP cache.
sub ez_user_hash {

    // Prevent tampering attacks on the hash mechanism
    if (req.restarts == 0
        &amp;&amp; (req.http.accept ~ &quot;application/vnd.fos.user-context-hash&quot;
            || req.http.x-user-hash
        )
    ) {
        return (synth(400));
    }

    if (req.restarts == 0 &amp;&amp; (req.method == &quot;GET&quot; || req.method == &quot;HEAD&quot;)) {
        // Get User (Context) hash, for varying cache by what user has access to.
        // https://doc.ez.no/display/EZP/Context+aware+HTTP+cache

        // Anonymous user w/o session =&gt; Use hardcoded anonymous hash to avoid backend lookup for hash
        if (req.http.Cookie !~ &quot;eZSESSID&quot; &amp;&amp; !req.http.authorization) {
            // You may update this hash with the actual one for anonymous user
            // to get a better cache hit ratio across anonymous users.
            // Note: You should then update it every time anonymous user rights change.
            set req.http.X-User-Hash = &quot;38015b703d82206ebc01d17a39c727e5&quot;;
        }
        // Pre-authenticate request to get shared cache, even when authenticated
        else {
            set req.http.x-fos-original-url    = req.url;
            set req.http.x-fos-original-accept = req.http.accept;
            set req.http.x-fos-original-cookie = req.http.cookie;
            // Clean up cookie for the hash request to only keep session cookie, as hash cache will vary on cookie.
            set req.http.cookie = &quot;;&quot; + req.http.cookie;
            set req.http.cookie = regsuball(req.http.cookie, &quot;; +&quot;, &quot;;&quot;);
            set req.http.cookie = regsuball(req.http.cookie, &quot;;(eZSESSID[^=]*)=&quot;, &quot;; \1=&quot;);
            set req.http.cookie = regsuball(req.http.cookie, &quot;;[^ ][^;]*&quot;, &quot;&quot;);
            set req.http.cookie = regsuball(req.http.cookie, &quot;^[; ]+|[; ]+$&quot;, &quot;&quot;);
            set req.http.accept = &quot;application/vnd.fos.user-context-hash&quot;;
            set req.url = &quot;/_fos_user_context_hash&quot;;

            // Force the lookup, the backend must tell how to cache/vary response containing the user hash
            return (hash);
        }
    }

    // Rebuild the original request which now has the hash.
    if (req.restarts &gt; 0
        &amp;&amp; req.http.accept == &quot;application/vnd.fos.user-context-hash&quot;
    ) {
        set req.url         = req.http.x-fos-original-url;
        set req.http.accept = req.http.x-fos-original-accept;
        set req.http.cookie = req.http.x-fos-original-cookie;
        unset req.http.x-fos-original-url;
        unset req.http.x-fos-original-accept;
        unset req.http.x-fos-original-cookie;

        // Force the lookup, the backend must tell not to cache or vary on the
        // user hash to properly separate cached data.

        return (hash);
    }
}

sub vcl_deliver {
    // On receiving the hash response, copy the hash header to the original
    // request and restart.
    if (req.restarts == 0
        &amp;&amp; resp.http.content-type ~ &quot;application/vnd.fos.user-context-hash&quot;
    ) {
        set req.http.x-user-hash = resp.http.x-user-hash;
        return (restart);
    }

    // If we get here, this is a real response that gets sent to the client.
    // Remove the vary on context user hash, this is nothing public. Keep all
    // other vary headers.
    set resp.http.Vary = regsub(resp.http.Vary, &quot;(?i),? *x-user-hash *&quot;, &quot;&quot;);
    set resp.http.Vary = regsub(resp.http.Vary, &quot;^, *&quot;, &quot;&quot;);
    if (resp.http.Vary == &quot;&quot;) {
        unset resp.http.Vary;
    }

    // Sanity check to prevent ever exposing the hash to a client.
    unset resp.http.x-user-hash;
    if (client.ip ~ debuggers) {
        if (obj.hits &gt; 0) {
            set resp.http.X-Cache = &quot;HIT&quot;;
            set resp.http.X-Cache-Hits = obj.hits;
        } else {
            set resp.http.X-Cache = &quot;MISS&quot;;
        }
    }
}]]></script>
</div></div><h4 id="ContextawareHTTPcache-NewanonymousX-User-Hash">New anonymous X-User-Hash</h4><p>The anonymous X-User-Hash is generated based on the <em>anonymous user</em>, <em>group</em> and <em>role</em>. The <code>38015b703d82206ebc01d17a39c727e5</code> hash that is provided in the code above will work only when these three variables are left unchanged. Once you change the default permissions and settings, the X-User-Hash will change and Varnish won't be able to effectively handle cache anymore.</p><p>In that case you need to find out the new anonymous X-User-Hash and change the VCL accordingly, else Varnish will return a no-cache header.</p><p>The easiest way to find the new hash is:</p><p><strong>1.</strong> Connect to your server (<em>shh</em> should be enough)</p><p><strong>2.</strong> Add <code>&lt;your-domain.com&gt;</code> to your <code>/etc/hosts</code> file</p><p><strong>3.</strong> Execute the following command:</p><p><code>curl -I -H &quot;Accept: application/vnd.fos.user-context-hash&quot; http://&lt;your-domain.com&gt;/_fos_user_context_hash</code></p><p>You should get a result like this:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script type="syntaxhighlighter" class="brush: php; gutter: false; theme: Eclipse"><![CDATA[HTTP/1.1 200 OK
Date: Mon, 03 Oct 2016 15:34:08 GMT
Server: Apache/2.4.18 (Ubuntu)
X-Powered-By: PHP/7.0.8-0ubuntu0.16.04.2
X-User-Hash: b1731d46b0e7a375a5b024e950fdb8d49dd25af85a5c7dd5116ad2a18cda82cb
Cache-Control: max-age=600, public
Vary: Cookie,Authorization
Content-Type: application/vnd.fos.user-context-hash]]></script>
</div></div><p><strong>4.</strong> Now, replace the existing X-User-Hash value with the new one:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script type="syntaxhighlighter" class="brush: php; gutter: false; theme: Eclipse"><![CDATA[# Note: This needs update every time anonymous user role assignments change.
set req.http.X-User-Hash = &quot;b1731d46b0e7a375a5b024e950fdb8d49dd25af85a5c7dd5116ad2a18cda82cb&quot;;]]></script>
</div></div><p><strong>5.</strong> Restart the Varnish server and everything should work fine.</p><h3 id="ContextawareHTTPcache-DefaultoptionsforFOSHttpCacheBundledefinedineZ">Default options for FOSHttpCacheBundle defined in eZ</h3><p>The following configuration is defined in eZ by default for FOSHttpCacheBundle. You may override these settings.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<script type="syntaxhighlighter" class="brush: bash; gutter: false; theme: Eclipse"><![CDATA[fos_http_cache: 
    proxy_client: 
        # &quot;varnish&quot; is used, even when using Symfony HttpCache.
        default: varnish
        varnish: 
            # Means http_cache.purge_servers defined for current SiteAccess.
            servers: [$http_cache.purge_servers$]

    user_context: 
        enabled: true
        # User context hash is cached during 10min
        hash_cache_ttl: 600
        user_hash_header: X-User-Hash]]></script>
</div></div><p> </p><div class="highlight highlight-yaml"><pre><span class="sh"> </span></pre><h2 id="ContextawareHTTPcache-Credits">Credits</h2><p>This feature is based on <a href="http://asm89.github.io/2012/09/26/context-aware-http-caching.html" class="external-link" rel="nofollow">Context aware HTTP caching post</a> by <a href="https://github.com/asm89" class="external-link" rel="nofollow">asm89</a>.</p></div>

                
        
    
        </div>

        <!--
<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:trackback="http://madskills.com/public/xml/rss/module/trackback/">
         <rdf:Description
    rdf:about="https://doc.ez.no/display/EZP/Context+aware+HTTP+cache"
    dc:identifier="https://doc.ez.no/display/EZP/Context+aware+HTTP+cache"
    dc:title="Context aware HTTP cache"
    trackback:ping="https://doc.ez.no/rpc/trackback/14712846"/>
</rdf:RDF>
-->

            
    



<div id="labels-section" class="pageSection group">
    <div class="labels-section-content content-column" entityid="14712846" entitytype="page">
	<div class="labels-content">
		
    <ul class="label-list label-list-right ">
                    
        <li class="aui-label " data-label-id="15630339"><a class="aui-label-split-main" href="../../label/EZP/http.html" rel="tag">http</a></li><li class="aui-label " data-label-id="15630338"><a class="aui-label-split-main" href="../../label/EZP/cache.html" rel="tag">cache</a></li><li class="aui-label " data-label-id="23986204"><a class="aui-label-split-main" href="../../label/EZP/context.html" rel="tag">context</a></li><li class="aui-label " data-label-id="15630337"><a class="aui-label-split-main" href="../../label/EZP/workflow.html" rel="tag">workflow</a></li><li class="aui-label " data-label-id="26443781"><a class="aui-label-split-main" href="../../label/EZP/vcl.html" rel="tag">vcl</a></li><li class="aui-label " data-label-id="26443782"><a class="aui-label-split-main" href="../../label/EZP/varnish.html" rel="tag">varnish</a></li>
            </ul>

    </div>
</div>
</div>

                    <div id="children-section" class="pageSection children-showing group">
                
        <div class="section-header ">
            <h2 id="children-section-title" class="section-title">
                <a href="Context%2baware%2bHTTP%2bcache6da2.html?showChildren=false#children" class="children-show-hide">
                                            1 Child Page
                                    </a>
            </h2>

            <a href="Context%2baware%2bHTTP%2bcache6da2.html?showChildren=false#children" class="children-show-hide icon"></a>
            <!--
            <span class="noprint grey">
                <a class="children-subtitle" href="/pages/listpages-dirview.action?key=EZP&amp;openId=14712846#selectedPageInHierarchy">Reorder Pages</a>
                            </span>
            -->
        </div>
        <div id="page-children" class="pageSectionBody children-loaded">
                                        <span class="child-display">
                                 <span class="icon aui-icon aui-icon-small aui-iconfont-page-default" title="Page">Page:</span>                 <a href="Context%2baware%2bHTTP%2bcache%2bin%2beZ%2bPublish%2b5.2-5.html">Context aware HTTP cache in Exponential 5.2-5.3</a>
                         </span>
                                </div>
        </div>
    
            




            
    








                        
    
<div id="comments-section" class="pageSection group">
        
    



</div>


            
</div>


    




    
    

    
    
    








</div>
  
        <div id="theme-footer">
            <p>© 1999-2016 <a href="http://ez.no/" class="external-link" rel="nofollow">eZ Systems AS</a> and others</p>
        </div>
    
    </div>
</div>


        
            
            

<div id="footer" role="contentinfo">
    <section class="footer-body">

                                                            <p class="license license-opensource">
                    Powered by a free <b>Atlassian Confluence Open Source Project License</b> granted to Exponential. <a href="http://www.atlassian.com/c/conf/11461">Evaluate Confluence today</a>.<br>
                </p>
                    
        

        <ul id="poweredby">
            <li class="noprint">Powered by <a href="http://www.atlassian.com/software/confluence" class="hover-footer-link">Atlassian Confluence</a> <span id='footer-build-information'>5.8.5</span>, <a href="http://www.atlassian.com/software/confluence/overview/team-collaboration-software?utm_source=confluence-footer" class="hover-footer-link">Team Collaboration Software</a></li>
            <li class="print-only">Printed by Atlassian Confluence 5.8.5, Team Collaboration Software.</li>
            <li class="noprint"><a href="https://jira.atlassian.com/browse/CONF" class="hover-footer-link">Report a bug</a></li>
            <li class="noprint"><a href="http://www.atlassian.com/about/connected.jsp?s_kwcid=Confluence-stayintouch" class="hover-footer-link">Atlassian News</a></li>
        </ul>

        

        <div id="footer-logo"><a href="http://www.atlassian.com/">Atlassian</a></div>

                    <script>
AJS.toInit(function(){
 if(AJS.params.spaceKey &&
    AJS.params.spaceKey === 'MAIN' ||
    AJS.params.spaceKey === 'EZMA' ||
    AJS.params.spaceKey === 'ODC' ||
    AJS.params.spaceKey === 'EZP50' ||
    AJS.params.spaceKey === 'EZP51' ||
    AJS.params.spaceKey === 'EZP52' ||
    AJS.params.spaceKey === 'EZPCLOUD' ||
    AJS.params.spaceKey === 'EZP' ||
    AJS.params.spaceKey === 'TECHDOC' ||
    AJS.params.spaceKey === 'USERGUIDE' ||
    AJS.params.spaceKey === 'EZRECO'
){

(function()
{var isSecure=('https:'==document.location.protocol);var ff=document.createElement('script');ff.type='text/javascript';ff.async=true;ff.src=(isSecure?'https':'http')+'://'+(isSecure?'secure.':'lb.')+'liveviewer.ez.no/statjs/sst-120-1304513615/stat.js';var s=document.getElementsByTagName('script')[0];s.parentNode.insertBefore(ff,s);}
)();

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','http://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-303624-13', 'ez.no');
  ga('send', 'pageview');
}}
);
</script>
        
    </section>
</div>

    </div>
</body>

<!-- Mirrored from doc.ez.no/display/EZP/Context+aware+HTTP+cache?showChildren=true by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 11:11:12 GMT -->
</html>
