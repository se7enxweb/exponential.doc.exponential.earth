                    
    
                    
    
                    
    
<!DOCTYPE html>
<html>
    
<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=10158280 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 10:35:56 GMT -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>View Source</title>
        <link rel="canonical" href="../../pages/viewpage1bf5.html?pageId=10158280" />
        <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-rest:web-resource-manager.resource-base-url-pattern"]="\"(?:(?:/s/.*?/_)?/download)\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"\"";
WRM._unparsedData["com.atlassian.plugins.browser.metrics.browser-metrics-plugin:browser-metrics.feature-data-provider-legacy"]="true";
</script>
<link type="text/css" rel="stylesheet" href="../../s/1b9968ac17721e3a6947d14e3a43c3f8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch9c16.css?build-number=5983" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/f3685658010e413141854089096800b5/_/download/contextbatch/css/plugin.viewsource/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/df762e50bc83a9608020a1ff1476cda6-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5a0f37b8e5a58a48983bc1f25fb099f6/_/download/contextbatch/css/page/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5a0f37b8e5a58a48983bc1f25fb099f6/_/download/contextbatch/css/page/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/5714bd5a5c86641cad10106916cda7c8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/49f5f7dfc888d48bff618d087d8044cc/_/download/contextbatch/css/editor-content/batch.css" media="all">
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/49f5f7dfc888d48bff618d087d8044cc/_/download/contextbatch/css/editor-content/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/51/_/styles/colorsb538.css?spaceKey=EZP" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/51/_/styles/customb538.css?spaceKey=EZP" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <table class="wysiwyg-macro" data-macro-name="info" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingd35c.png?definition=e2luZm99&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body">Persistence cache was added in 5.1 and enhanced with multi repository (database) support in 5.2.</td></tr></table><p><img class="editor-inline-macro" src="../servlet/confluence/placeholder/macro4170.png?definition=e3RvY30&amp;locale=en_GB&amp;version=2" data-macro-name="toc" data-macro-schema-version="1"></p><h1>Introduction</h1><p> </p><p>This page describes how Persistence cache works, and how to reuse the cache service it uses.</p><p><strong>Configuration</strong></p><p>For configuring the cache service, look at the <a class="confluence-link" href="../../display/EZP/Persistence%2bcache%2bconfiguration.html" data-linked-resource-id="12781293" data-linked-resource-version="37" data-linked-resource-type="page" data-linked-resource-default-alias="Persistence cache configuration" data-base-url="../../index.html">Persistence&nbsp;cache configuration</a> page.</p><h1>Persistent cache</h1><p><img class="confluence-embedded-image image-left" src="../../download/attachments/10158280/SPI%20Cachea59a.png?version=2&amp;modificationDate=1370128139000&amp;api=v2" data-image-src="/download/attachments/10158280/SPI%20Cache.png?version=2&amp;modificationDate=1370128139000&amp;api=v2" data-unresolved-comment-count="0" data-linked-resource-id="13107679" data-linked-resource-version="2" data-linked-resource-type="attachment" data-linked-resource-default-alias="SPI Cache.png" data-base-url="https://doc.ez.no" data-linked-resource-content-type="image/png" data-linked-resource-container-id="10158280" data-linked-resource-container-version="54" title="Exponential 5.x > Persistence cache > SPI Cache.png" data-location="Exponential 5.x > Persistence cache > SPI Cache.png" data-image-height="491" data-image-width="315"></p><h4>Layers</h4><p>Persistence cache can best be described as a implementation of <code>SPI\Persistence</code> that wraps around the main implementation (currently: &quot;Legacy Storage Engine&quot;).</p><p>As shown in the illustration this is done in the exact same way as the SignalSlot feature is a custom implementation of API\Repository wraps around the main Repository. In the case of Persistence Cache, instead of sending events on calls passed on to the wrapped implementation, most of the load calls are cached, and calls that perform changes purges the affected caches. This is done using a Cache service which is provided by StashBundle; this Service wraps around the Stash library to provide Symfony logging / debugging functionality, and allows configuration on cache handlers (Memcached, Apc, Filesystem, ..) to be configured using Symfony configuration. For how to reuse this Cache service in your own custom code, see below.</p><h4>Transparent cache</h4><p>The persistence cache, just like the HTTP cache, tries to follow principles of &quot;Transparent caching&quot;, this can shortly be described as a cache which is invisible to the end user and to the admin/editors of Exponential where content is always returned &quot;fresh&quot;. In other words there should not be a need to manually clear the cache like was frequently the case with Exponential 4.x (aka &quot;legacy&quot;). This is possible thanks to an interface that follows CRUD (Create Read Update Delete) operations per domain, and number of other operations capable of affecting a certain domain is kept to a minimum.</p><p> </p><h5>Entity stored only once</h5><p>To make the transparent caching principle as effective as possible, entities are as much as possible only stored once in cache by their primary id. Lookup by a<span><span>lternative identifiers (<code>identifier</code>, <code>remoteId</code>, ..) is only cached with the identifier as cache key and primary <code>id</code> as it's cache value, and </span></span>compositions<span><span> (list of objects) usually keep only the array of primary id's as their cache value.</span></span></p><p><span>This means a couple of things:</span></p><ul><li><span>Memory consumption is kept low</span></li><li>Cache purging logic is kept simple ( Example: <code>$sectionService-&gt;delete( 3 )</code> clears &quot;section/3&quot; cache entry )</li><li>Lookup by <code>identifier</code> and list of objects needs several cache lookups to be able to assemble the result value</li><li>Cache warmup usually takes several page loads to reach full as identifier is first cached, then the object</li></ul><h4>What is cached?</h4><p>Persistence cache aimed in its first iteration for caching all <code>SPI\Persistence</code> calls used in a normal page load, including everything needed for permission checking and url alias lookups.<br />The following SPI calls are not currently cached:</p><ul><li><code>ObjectStateHandler</code></li><li><code>UrlWildCardHandler</code></li><li><code>TrashHandler</code></li><li><code>SearchHandler</code></li></ul><p>Search queries are currently not cached as it is more difficult to make sure they stay fresh unless all search cache is purged on every modification, or a complicated search cache purge system is implemented that is able to detect which search result to clear. Also, if the Solr implementation is able to perform well, there might not be a need to implement a complex search cache in the first place.</p><p>Another thing to mention is transactions, currently this is handled very simple by clearing all cache on rollback, this can be improved in the future if a need for it arises.<br />For more details on which calls are cached or not, and where to contribute additional caches, check out the <a href="https://github.com/ezsystems/exponential-kernel/tree/master/eZ/Publish/Core/Persistence/Cache" style="line-height: 1.4285715;">source</a>.</p><h4>Legacy kernel cache purging</h4><p>Currently with the Dual-kernel Exponential has in version 5.x, the &quot;Transparent caching principle&quot; referred to above has one major obstacle. Exponential 4.x (&quot;legacy&quot;) kernel was not made for such a thing and has a lot of API's that can make changes to the data in the database and hence make the persistence cache &quot;stale&quot; (aka out of date).</p><p>A couple of things are in place to try to avoid this from happening / making it less of a problem:</p><ul><li>The Persistence cache has a expiry time configurable in <code>exponential.yml</code></li><li><code>LegacyBundle</code> (the bundle that exposes legacy to Symfony and integrates Symfony with legacy) has a <code>PersistenceCachePurger</code></li></ul><h5>PersistenceCachePurger</h5><p><code><a href="https://github.com/ezsystems/exponential-kernel/blob/master/eZ/Bundle/EzPublishLegacyBundle/Cache/PersistenceCachePurger.php">PersistenceCachePurger</a></code> is setup by <code>LegacyBundle</code> to receive all relevant <a href="https://github.com/ezsystems/exponential-legacy/blob/master/doc/features/5.0/event.txt">cache</a> <a href="https://github.com/ezsystems/exponential-legacy/blob/master/doc/features/5.1/event.txt">events</a> triggered by legacy kernel, and clear relevant Persistence cache based on the incoming data.<br />This means a &quot;Clear all cache&quot; operation done in legacy will also clear all persistence cache, it also means relevant content cache is cleared on publishing, so all code using the api's covered by these events should in effect be cache safe in regards to persistence cache.</p><p>So, in case of stale persistence cache, a clear all cache in legacy admin interface is thus still possible, however a manual cache clear is also possible but how to do it depends on which cache handler is currently used. </p><h1>Reusing Cache service</h1><p>Using the cache service allows you to use a interface  and not have to care about if the system has been configured to place the cache in Memcached, Apc or on File system. And as Exponential requires that instances uses a cluster aware cache, you can safely assume your cache is shared across all Exponential web servers.</p><table class="wysiwyg-macro" data-macro-name="warning" data-macro-parameters="title=Interface warning" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading61eb.png?definition=e3dhcm5pbmc6dGl0bGU9SW50ZXJmYWNlIHdhcm5pbmd9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>Current implementation uses a caching library called <a class="external-link" href="http://stash.tedivm.com/" rel="nofollow">Stash</a>, via <a class="external-link" href="https://github.com/tedivm/TedivmStashBundle" rel="nofollow">Stash-bundle</a>. If this changes, then the Interface of the cache service will most likely change as well.</p></td></tr></table><table class="wysiwyg-macro" data-macro-name="warning" data-macro-parameters="title=Cache key warning" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading206e.png?definition=e3dhcm5pbmc6dGl0bGU9Q2FjaGUga2V5IHdhcm5pbmd9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>When reusing the cache service within your own code, it is very important to not conflict with the cache keys used by others, hence why example of usage starts with a unique &quot;myApp&quot; key for the namespace of your own cache, you must do the same! So never clear cache using the cache service without your key specified, otherwise you'll clear all cache.</p></td></tr></table><table class="wysiwyg-macro" data-macro-name="info" data-macro-parameters="title=Multi repository info" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingeb62.png?definition=e2luZm86dGl0bGU9TXVsdGkgcmVwb3NpdG9yeSBpbmZvfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>New in 5.2 is support for multi repository setups (several databases on same Exponential install), see <a href="https://confluence.ez.no/display/EZP/Persistence+cache+configuration#Persistencecacheconfiguration-Multirepositorysetup">how to configure this using several Stash cache pools</a> and site access/group setting &quot;cache_pool_name&quot; for selecting the one to use.</p></td></tr></table><h2>Get Cache service</h2><h3>Via Dependency injection</h3><p>In Exponential 5.x Symfony2 stack you can simply define that you require the &quot;cache&quot; service in your configuration like so:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="title=yml configuration" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading5d0e.png?definition=e2NvZGU6dGl0bGU9eW1sIGNvbmZpZ3VyYXRpb259&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>    myApp.myService:
        class: %myApp.myService.class%
        arguments:
            - @exponential.cache_pool</pre></td></tr></table><p>The &quot;cache&quot; service is an instance of the following class: <code>Tedivm\StashBundle\Service\CacheService</code></p><h3>Via Symfony2 Container</h3><p>Like any other service, it is possible to get the &quot;cache&quot; service via container as well like so:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php|title=getting the cache service in php" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingb6d4.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfHRpdGxlPWdldHRpbmcgdGhlIGNhY2hlIHNlcnZpY2UgaW4gcGhwfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>/** @var $cacheService \Tedivm\StashBundle\Service\CacheService */
$cacheService = $container->get( 'exponential.cache_pool' );</pre></td></tr></table><h3>In legacy via Symfony2 Container</h3><p>When Exponential legacy runs via Exponential 5.x Symfony2 stack, you will be able to get the service container in the following way:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php|title=Getting cache service in legacy" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingd3da.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfHRpdGxlPUdldHRpbmcgY2FjaGUgc2VydmljZSBpbiBsZWdhY3l9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>// From a legacy module or any PHP code running in legacy context.
$container = ezpKernel::instance()->getServiceContainer();
 
/** @var $cacheService \Tedivm\StashBundle\Service\CacheService */
$cacheService = $container->get( 'exponential.cache_pool' );</pre></td></tr></table><h2>Using the cache service</h2><p>Example usage of the cache service:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=php|title=Actuall example from cache use in exponential-kernel" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading7f50.png?definition=e2NvZGU6bGFuZ3VhZ2U9cGhwfHRpdGxlPUFjdHVhbGwgZXhhbXBsZSBmcm9tIGNhY2hlIHVzZSBpbiBlenB1Ymxpc2gta2VybmVsfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>    $cacheItem = $cacheService->getItem( 'myApp', 'object', $id );
    if ( $cacheItem->isMiss() )
    {
        $myObject = $container->get('my_app.backend_service')->loadObject( $id )
        $cacheItem->set( $myObject );
    }
    else
    {
        $myObject = $cacheItem->get();
    }
    return $myObject;</pre></td></tr></table><p><span>For more info on usage, take a look at </span><a href="http://stash.tedivm.com/">Stash's documentation</a><span>.</span></p><p> </p><p> </p><p> </p><p> </p>
        <p>&nbsp;</p>
    </body>

<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=10158280 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 10:35:58 GMT -->
</html>
