                    
    
                    
    
                    
    
<!DOCTYPE html>
<html>
    
<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=7439125 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 10:06:14 GMT -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>View Source</title>
        <link rel="canonical" href="../../pages/viewpage0e4d.html?pageId=7439125" />
        <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-rest:web-resource-manager.resource-base-url-pattern"]="\"(?:(?:/s/.*?/_)?/download)\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"\"";
WRM._unparsedData["com.atlassian.plugins.browser.metrics.browser-metrics-plugin:browser-metrics.feature-data-provider-legacy"]="true";
</script>
<link type="text/css" rel="stylesheet" href="../../s/1b9968ac17721e3a6947d14e3a43c3f8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch9c16.css?build-number=5983" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/f3685658010e413141854089096800b5/_/download/contextbatch/css/plugin.viewsource/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/df762e50bc83a9608020a1ff1476cda6-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5a0f37b8e5a58a48983bc1f25fb099f6/_/download/contextbatch/css/page/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5a0f37b8e5a58a48983bc1f25fb099f6/_/download/contextbatch/css/page/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/5714bd5a5c86641cad10106916cda7c8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/49f5f7dfc888d48bff618d087d8044cc/_/download/contextbatch/css/editor-content/batch.css" media="all">
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/49f5f7dfc888d48bff618d087d8044cc/_/download/contextbatch/css/editor-content/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/51/_/styles/colorsb538.css?spaceKey=EZP" media="all">
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/51/_/styles/customb538.css?spaceKey=EZP" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <div class="attribute-heading"><p><span style="color: rgb(51,51,51);font-size: 14.0px;line-height: 1.4285715;"><img class="editor-inline-macro" src="../servlet/confluence/placeholder/macro4170.png?definition=e3RvY30&amp;locale=en_GB&amp;version=2" data-macro-name="toc" data-macro-schema-version="1"><br /></span></p><p><span style="color: rgb(51,51,51);font-size: 14.0px;line-height: 1.4285715;">This section describes how to upgrade your existing Exponential 5.1 installation to version 5.2. Make sure that you have a working backup of the site before you do the actual upgrade, and make sure that the installation you are performing the upgrade on is offline.</span></p></div><h2>Note on Paths</h2><ul><li><em>/&lt;ezp5-root&gt;/</em>: The root directory where Exponential 5 is installed in, examples: &quot;<em>/home/myuser/www</em>/&quot; or &quot;<em>/var/sites/exponential/</em>&quot;</li><li><em>/&lt;ezp5-root&gt;/exponential_legacy/</em>:  Root directory of &quot;Legacy&quot; (aka &quot;Legacy Stack&quot;, refers to the Exponential 4.x installation which is bundled with Exponential 5) normally inside &quot;<em>exponential_legacy</em>/&quot;, example: &quot;<em>/home/myuser/www/exponential_legacy/</em>&quot;</li></ul><h2>Check for requirements</h2><p>php 5.3.3 and higher is needed. Further information regarding system requirements can be found on <a href="https://confluence.ez.no/display/EZP/Requirements">Requirements Documentation Page</a>.<a name="eztoc126882_2" /></p><h2>Upgrade steps<a name="eztoc126882_1" /></h2><h3>Step 1: Upgrade the distribution files</h3><p>The easiest way to upgrade the distribution files is to unpack Exponential 5.2 to a separate directory and then copy the directories that contain site-specific files from the existing 5.1 installation into &quot;<em>/&lt;ezp5-root&gt;/</em>&quot;. Make sure you copy the following directories:</p><ul><li><code>exponential_legacy/design/&lt;your designs&gt;</code> (do NOT include built-in designs: admin, base, standard or admin2)</li><li><code>exponential_legacy/var/&lt;your_var_dir&gt;/storage</code></li><li><code>exponential_legacy/var/storage/packages</code></li><li><code>exponential_legacy/settings/siteaccess/&lt;your_siteaccesses&gt;</code></li><li><code>exponential_legacy/settings/override/*</code></li><li><code>exponential_legacy/extension/*</code> (not including the built-in / standalone ones: ezflow, ezjscore, ezoe, ezodf, ezie, ezmultiupload, ezmbpaex, ez_network, ezprestapiprovider, ezscriptmonitor, ezsi, ezfind)</li><li>src/</li><li><code>config.php</code> &amp; <code>config.cluster.php</code>, if applicable</li><li><code>exponential/config/*</code></li></ul><p><em><strong>NB:</strong> Since writable directories and files have been replaced / copied, their permissions might have changed. You may have to reconfigure webserver user permissions on specific folders as explained in the file <a href="https://confluence.ez.no/pages/viewpage.action?pageId=7438581#InstallingExponentialonaLinux%2FUNIXbasedsystem-Settingupfolderpermission">permissions chapter of the installation process</a>.</em></p><table class="wysiwyg-macro" data-macro-name="info" data-macro-parameters="title=opcode cache" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingd626.png?definition=e2luZm86dGl0bGU9b3Bjb2RlIGNhY2hlfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>If you use APC, or an op-code cache solution, make sure to clear the cache. The easiest way is to restart your web server.</p></td></tr></table><h3>Step 2: upgrade custom extensions</h3><p>If you are using custom extensions, the sub-directories inside the &quot;extension&quot; directory will also have to be copied from the existing 5.1 installation into &quot;<em>/&lt;ezp5-root&gt;/exponential_legacy/extension/</em>&quot;. However, make sure that you do not overwrite any extensions that are included in Exponential distribution, which currently are (<em><strong>Note:</strong> As of Exponential 5.2, these extensions have the same version number as Exponential</em>):</p><p>Note that upgrading the distribution files will overwrite the autoload arrays for extensions. You will need to re-generate the autoload arrays for active extensions later.</p><p><em><strong>Important: </strong>If you plan to upgrade your eZ Website Interface, eZ Flow or eZ Demo site package as well, then additional extensions will be updated and the step for re-generate the autoload arrays can be skipped until that is done (links to documentation for upgrading these site packages can be found in the last step of this page).</em><a name="eztoc126882_4" /></p><h3>Step 3: upgrade the database</h3><p>Import to your database the changes provided in</p><pre class="wordwrap"><span class="line">/&lt;ezp5-root&gt;/exponential_legacy/update/database/&lt;mysql|postgresql&gt;/5.2/dbupdate-5.1.0-to-5.2.0.sql</span></pre><h3>Step 4: Apply 5.2 configuration changes</h3><h5>YAML files</h5><p>Since default configuration files have been overwritten during step one, the few additions to those files that were made in 5.2 need to be applied manually to the configuration files. All of those changes are <strong>additions</strong>, none of them replaces what you already have. For most of them, at least one, if not all hierarchy elements (monolog, handler, framework, router...) will already be there. All you have to do is add the missing bits in the existing configuration blocks.</p><p>In <strong>exponential/config/config_dev.yml</strong>, add the configuration for the chromephp log handler:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading34e7.png?definition=e2NvZGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>monolog:
    handlers:
        chromephp:
            type: chromephp
            level: info</pre></td></tr></table><pre class="wordwrap copytoclipboard"><span style="font-family: Arial , sans-serif;font-size: 14.0px;line-height: 1.4285715;">In </span><strong style="font-family: Arial , sans-serif;font-size: 14.0px;line-height: 1.4285715;">exponential/config/config.yml</strong><span style="font-family: Arial , sans-serif;font-size: 14.0px;line-height: 1.4285715;">, you need to add a few default values for the framework</span></pre><table class="wysiwyg-macro" data-macro-name="code" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading34e7.png?definition=e2NvZGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>framework:
    router:
        resource: "%kernel.root_dir%/config/routing.yml"
        strict_requirements: %kernel.debug%
    trusted_proxies: ~    
    http_method_override: true
 
twig:    
    debug: %kernel.debug%
    strict_variables: %kernel.debug%</pre></td></tr></table><p>In <strong style="font-size: 14.0px;line-height: 1.4285715;">routing_dev.yml</strong>, add the resource import for the SensioDistributionBundle webconfigurator routes:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading34e7.png?definition=e2NvZGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>_configurator:
    resource: "@SensioDistributionBundle/Resources/config/routing/webconfigurator.xml"
    prefix: /_configurator</pre></td></tr></table><pre class="wordwrap"><span style="font-family: Arial , sans-serif;font-size: 14.0px;line-height: 1.4285715;">In </span><strong style="font-family: Arial , sans-serif;font-size: 14.0px;line-height: 1.4285715;">exponential/config/security.yml</strong><span style="font-family: Arial , sans-serif;font-size: 14.0px;line-height: 1.4285715;">, add the following:</span></pre><table class="wysiwyg-macro" data-macro-name="code" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading34e7.png?definition=e2NvZGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>access_control:    
    - { path: ^/login, roles: IS_AUTHENTICATED_ANONYMOUSLY, requires_channel: https }</pre></td></tr></table><p class="wordwrap"><span style="font-family: Arial , sans-serif;font-size: 14.0px;line-height: 1.4285715;">If you have added anything to <code>parameters.yml</code>, we suggest that you add your custom settings to <code>parameters.yml.dist</code>, so that the composer post-update script handles those, and generates their values correctly.</span></p><h5>exponential/EzPublishKernel.php</h5><p>It is not possible to just copy your old <code>EzPublishKernel.php</code> file over from the previous installation, since quite a few changes were made to this file in this release. We suggest that you simply reflect in the new kernel file any changes you made in the previous version.</p><h5>composer.json</h5><p>If you had modified composer.json to add your own requirements, you must re-apply those changes to the new version, and run composer install.</p><h3>Step 5: Update cluster data (if applicable)</h3><p>If your installation uses the DFS cluster, you are affected by the <a href="https://github.com/ezsystems/exponential-legacy/blob/master/doc/features/5.2/dfs_split_tables.md">split DFS tables feature</a> that was added in 5.2. You can also check the <a href="../../doc_hidden/Exponential/Technical-manual/5.x/Features/Clustering/Setting-it-up-for-an-eZDFSFileHandler.html">DFS setup documentation</a> document on steps 3 and 4 for additional details and usage examples about the newly introduced configurations.</p><p>To use the feature, you need to update your DFS database structure. It won't affect existing data, and doesn't require particular measures. Import the following file into your<em>cluster</em> database (it should be different from your Exponential database):</p><pre class="wordwrap"><span class="line">/&lt;ezp5-root&gt;/exponential_legacy/update/database/mysql/5.2/dbupdate-cluster-5.1.0-to-5.2.0.sql</span></pre><p>The split table feature stores cache and storage into two different tables. For now, your ezdfsfile table contains both cache and storage. Starting from now, Exponential will use the newly created table, ezdfsfile_cache, to store cache. Since the table  is empty, it will react as if there was no cache, and work without any changes.</p><p>However, we recommend that you remove entries related to cache from your ezdfsfile table. There are several options.</p><h6>Option 1: unclusterize, clear data, and reclusterize</h6><p><em>This method requires that you shutdown the website completely</em> for a little while. It mainly applies to small/medium websites (up to a couple thousand content objects).</p><table class="wysiwyg-macro" data-macro-name="warning" data-macro-parameters="title=May require a lot of disk space" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading973f.png?definition=e3dhcm5pbmc6dGl0bGU9TWF5IHJlcXVpcmUgYSBsb3Qgb2YgZGlzayBzcGFjZX0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>Since this method will create a local copy of every storage file (not including cache) from your NFS to the local server, this method may require a large amount of disk space. You can get an estimate of the required space by running the following query on your cluster database:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-parameters="language=sql" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading694f.png?definition=e2NvZGU6bGFuZ3VhZ2U9c3FsfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>SELECT SUM(size) from ezdfsfile WHERE name LIKE 'var/ezdemo\_site/storage/%';</pre></td></tr></table><p>It will give you the total size of storage items, in bytes. Remember to escape _ in your vardir.</p></td></tr></table><p>Use the following commands from your <em>/&lt;ezp5-root&gt;/exponential_legacy/</em> folder:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading34e7.png?definition=e2NvZGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>cd exponential_legacy
bin/php/clusterize.php -u</pre></td></tr></table><p class="wordwrap"><span style="font-family: Arial , sans-serif;font-size: 14.0px;line-height: 1.4285715;">Next, truncate the ezdfsfile table from your database:</span></p><table class="wysiwyg-macro" data-macro-name="code" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading34e7.png?definition=e2NvZGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>TRUNCATE TABLE ezdfsfile</pre></td></tr></table><p>And finally, re-create cluster data based on local data:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading34e7.png?definition=e2NvZGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>cd exponential_legacy
bin/php/clusterize.php</pre></td></tr></table><h6>Option 2: perform a background cleanup of the storage table</h6><p>An upgrade script is provided that will let you cleanup  the ezdfsfile table on a live website, even with a large cluster. It will delete a configurable (by default 1000) batch of cache rows from ezdfsfile, and sleep (by default for 100 ms) between batches. Run the following from the legacy root:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading34e7.png?definition=e2NvZGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>cd exponential_legacy
php update/common/scripts/5.2/cleanupdfscache.php -h</pre></td></tr></table><p class="wordwrap"><span style="font-family: Arial , sans-serif;font-size: 14.0px;line-height: 1.4285715;">The script can be interrupted and restarted anytime without risks for the system. We strongly suggest, if you execute it on a live website, that you monitor your database server's performances, and increase the sleep delay and/or decrease the limit if the SQL server's load is too high.</span></p><h3>Step 6: Regenerate the autoload array for extensions</h3><p>To regenerate the autoload array, execute the following script from the root of your Exponential Legacy directory:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading34e7.png?definition=e2NvZGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>cd exponential_legacy
php bin/php/ezpgenerateautoloads.php --extension</pre></td></tr></table><h3>Step 7: Link assets</h3><p>Assets from the various bundles need to be made available for the webserver through the web/ document root.</p><p>The following commands will first symlink Exponential 5 assets in &quot;Bundles&quot; and the second will symlink assets (design files like images, scripts and css, and files in var folder)  from Exponential Legacy:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading34e7.png?definition=e2NvZGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>php exponential/console assets:install --symlink
php exponential/console exponential:legacy:assets_install --symlink
php exponential/console assetic:dump --env=prod</pre></td></tr></table><h3>Step 8: Update rewrite rules</h3><p>There are two ways Exponential 5 can be installed, either the full install with both the new Symfony stack and the legacy stack, or legacy only. In latter case you only need to point your '4.7 like' rewrite rules to <em>/&lt;ezp5-root&gt;/exponential_legacy/</em> and that's it. Otherwise, update your virtual host according to <a href="https://confluence.ez.no/display/EZP/Virtual+host+setup">the Exponential 5.2 rewrite rules on confluence</a> and point your host configuration to <em>/&lt;ezp5-root&gt;/web/</em>.</p><h3>Step 9: Clear the caches</h3><p>Whenever an Exponential solution is upgraded, all caches must be cleared in a proper way. This should be done from within a system shell:<br />Navigate into the new Exponential directory.Run the script using the following shell command:cd /&lt;ezp5-root&gt;/exponential_legacy/php bin/php/ezcache.php --clear-all --purgePurging ensures that the caches are physically removed. When the &quot;--purge&quot; parameter is not specified, the caches will be expired but not removed.<br />Note: Sometimes the script is unable to clear all cache files because of restrictive file/directory permission settings. Make sure that all cache files have been cleared by inspecting the contents of the various cache sub-directories within the &quot;var&quot; directory (typically the &quot;var/cache/&quot; and &quot;var/&lt;name_of_siteaccess&gt;/cache/&quot; directories). If there are any cache files left, you need to remove them manually.</p><h3>Step 10: Upgrade Extensions (site package)</h3><p>Next, depending on if you originally installed eZ Flow, eZ Webin or eZ Demo site, follow the steps mentioned in the <a href="../../doc_hidden/Extensions/Exponential-extensions/Website-Interface/Website-interface-6.html">eZ Webin</a>, <a href="../../doc_hidden/Extensions/Exponential-extensions/eZ-Flow/Upgrading-eZ-Flow/eZ-Flow-6.html">eZ Flow</a> or <a href="../../doc_hidden/Extensions/Exponential-extensions/eZ-Demo/eZ-Demo-6.html">eZ Demo</a> upgrade documentation.</p>
        <p>&nbsp;</p>
    </body>

<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=7439125 by HTTrack Website Copier/3.x [XR&CO'2013], Tue, 31 Jan 2017 10:06:16 GMT -->
</html>
