                    
    
                    
    
                    
    
<!DOCTYPE html>
<html>
    
<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=32114390 by HTTrack Website Copier/3.x [XR&CO'2013], Wed, 01 Feb 2017 02:56:40 GMT -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>View Source</title>
        <link rel="canonical" href="../../pages/viewpageb4ac.html?pageId=32114390" />
        <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-rest:web-resource-manager.resource-base-url-pattern"]="\"(?:(?:/s/.*?/_)?/download)\"";
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\"\"";
WRM._unparsedData["com.atlassian.plugins.browser.metrics.browser-metrics-plugin:browser-metrics.feature-data-provider-legacy"]="true";
</script>
<link type="text/css" rel="stylesheet" href="../../s/1b9968ac17721e3a6947d14e3a43c3f8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch9c16.css?build-number=5983" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/89/_/download/superbatch/css/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/f3685658010e413141854089096800b5/_/download/contextbatch/css/plugin.viewsource/batch.css" media="all">
<link type="text/css" rel="stylesheet" href="../../s/df762e50bc83a9608020a1ff1476cda6-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5a0f37b8e5a58a48983bc1f25fb099f6/_/download/contextbatch/css/page/batch.css" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/5a0f37b8e5a58a48983bc1f25fb099f6/_/download/contextbatch/css/page/batch.css?conditionalComment=lt+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/5714bd5a5c86641cad10106916cda7c8-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/49f5f7dfc888d48bff618d087d8044cc/_/download/contextbatch/css/editor-content/batch.css" media="all">
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/d41d8cd98f00b204e9800998ecf8427e-CDN/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/49f5f7dfc888d48bff618d087d8044cc/_/download/contextbatch/css/editor-content/batch.css?conditionalComment=lte+IE+9" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/16/_/styles/colors.css" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <div class="contentLayout2">
<div class="columnLayout two-right-sidebar" data-layout="two-right-sidebar">
<div class="cell normal" data-type="normal">
<div class="innerCell">
<table class="wysiwyg-macro" data-macro-name="note" data-macro-id="59d14898-7f5a-42f5-b77e-bba4241bc617" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingdd57.png?definition=e25vdGV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p><span>Version 1.0.x of Solr Bundle primarily aims to be used as replacement for Legacy (SQL-based) search engine for better scalability and performance <em>(especially with field criteria and sort clauses).</em> And while it also provides better full text search thanks to Solr, more advance search features like Faceting will come in later releases.</span></p></td></tr></table><p> </p><p> </p><h2>What is Solr Search Engine Bundle?</h2><p><a class="external-link" href="https://github.com/ezsystems/ezplatform-solr-search-engine" rel="nofollow">ezplatform-solr-search-engine</a> as the package is called, aims to be a transparent drop in replacement for the SQL based &quot;Legacy&quot; search engine powering Search API by default. By enabling Solr and re-indexing your content, all your existing Search queries using SearchService, will be powered by Solr automatically. This allows you to scale up your eZ Platform installation and be able to continue development locally against SQL engine, and have a test infrastructure, Staging and Prod powered by Solr, thus removing considerable load from your database so it can focus on more important things, like publishing <img class="emoticon emoticon-wink" data-emoticon-name="wink" border="0" src="../../s/en_GB/5983/f3e491afc761ac0a6981cfa3dcbc04fc7e88c149.16/_/images/icons/emoticons/wink.png" alt="(wink)" title="(wink)" />.</p><p><em>Se <a class="confluence-link" href="../../display/DEVELOPER/Architecture_%2bAn%2bOpen%2bSource%2bPHP%2bCMS%2bBuilt%2bOn%2bSymfony2%2bFull%2bStack.html" data-linked-resource-id="31429707" data-linked-resource-version="9" data-linked-resource-type="page" data-linked-resource-default-alias="Architecture: An Open Source PHP CMS Built On Symfony2 Full Stack" data-base-url="../../index.html">Architecture page</a> </em> <em> for further information on the architecture of eZ Platform.</em></p><h2>How to set up Solr Search engine</h2><h3>Step 1: Enabling the Bundle</h3><table class="wysiwyg-macro" data-macro-name="note" data-macro-id="bc249b40-78c3-416c-8abb-b90f0c9d3e80" data-macro-parameters="title=Not needed with eZ Platform" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingac44.png?definition=e25vdGU6dGl0bGU9Tm90IG5lZWRlZCB3aXRoIGVaIFBsYXRmb3JtfQ&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>This step is not needed for eZ Platform as of 15.09, however it is kept here for reference in case you have previously disabled the bundle.</p></td></tr></table><p> </p><ol><li><p>Add/Update composer dependencies:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="3ba5ee87-bcf5-4798-8ce1-44be907679ac" data-macro-parameters="language=bash|title=command line" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingba93.png?definition=e2NvZGU6bGFuZ3VhZ2U9YmFzaHx0aXRsZT1jb21tYW5kIGxpbmV9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>composer require --no-update ezsystems/ezplatform-solr-search-engine:~1.0
composer update</pre></td></tr></table></li><li>Activate EzPublishSolrSearchEngineBundle by adding the following lines to your <code>app/AppKernel.php</code> file: new <code>EzSystems\EzPlatformSolrSearchEngineBundle\EzSystemsEzPlatformSolrSearchEngineBundle()</code></li></ol><h3>Step 2: Configuring &amp; Starting Solr</h3><p> </p><table class="wysiwyg-macro" data-macro-name="note" data-macro-id="549d3fbf-218d-4096-8a3f-902548f1db00" data-macro-parameters="colour=Yellow" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headinge345.png?definition=e25vdGU6Y29sb3VyPVllbGxvd30&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body">Example here is for single core, look to <a href="https://cwiki.apache.org/confluence/display/solr/Solr+Cores+and+solr.xml">Solr</a> <a href="https://wiki.apache.org/solr/CoreAdmin">documentation</a> for configuring Solr in other ways, also see the provided configuration for some examples.</td></tr></table><p> </p><p>First download and extract Solr, <strong>we currently support Solr 4.10.4</strong>:</p><ul><li><a href="http://archive.apache.org/dist/lucene/solr/4.10.4/solr-4.10.4.tgz" style="line-height: 1.4285715;">solr-4.10.4.tgz</a> <span style="line-height: 1.4285715;"> or </span> <a href="http://archive.apache.org/dist/lucene/solr/4.10.4/solr-4.10.4.zip" style="line-height: 1.4285715;">solr-4.10.4.zip</a></li></ul><p> </p><p>Secondly, copy configuration files needed for eZ Solr Search Engine bundle,<em> here from the root of your project to the place you extracted Solr</em>:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="744c8abd-cd41-4423-b4e2-cc960618426d" data-macro-parameters="language=bash|title=Command line example" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading8f6a.png?definition=e2NvZGU6bGFuZ3VhZ2U9YmFzaHx0aXRsZT1Db21tYW5kIGxpbmUgZXhhbXBsZX0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre># Make sure to change the /opt/solr/ path with where you have placed Solr
cp -R vendor/ezsystems/ezplatform-solr-search-engine/lib/Resources/config/solr/* /opt/solr/example/solr/collection1/conf/

/opt/solr/bin/solr start -f </pre></td></tr></table><p> </p><p>Thirdly, Solr Bundle does not commit solr index changes directly on repository updates, leaving it up to you to tune this using <code>solrconfig.xml</code> as best practice suggests, example config:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="9deb7c10-2c2b-4319-b3c6-9351564d29a7" data-macro-parameters="title=solrconfig.xml" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading9555.png?definition=e2NvZGU6dGl0bGU9c29scmNvbmZpZy54bWx9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>&lt;autoCommit>
  &lt;!-- autoCommit is here left as-is like it is out of the box in Solr 4.10.4, this controls hard commits for durability/replication -->
  &lt;maxTime>${solr.autoCommit.maxTime:15000}&lt;/maxTime> 
  &lt;openSearcher>false&lt;/openSearcher> 
&lt;/autoCommit>

&lt;autoSoftCommit>
  &lt;!-- Soft commits controls mainly when changes becomes visible, by default we change value from -1 (disabled) to 100ms, to try to strike a balance between Solr performance and staleness of HttpCache generated by Solr queries -->
  &lt;maxTime>${solr.autoSoftCommit.maxTime:100}&lt;/maxTime> 
&lt;/autoSoftCommit></pre></td></tr></table><h3>Step 3: Configuring bundle</h3><p>The Solr search engine bundle can be configured many ways, here are some examples:</p><h4>Single Core example (default)</h4><p>Out of the box in eZ Platform the following is enabled for simple setup:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="fbff21e8-d8d0-4856-8edb-fb466e831eb9" data-macro-parameters="title=config.yml" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1984.png?definition=e2NvZGU6dGl0bGU9Y29uZmlnLnltbH0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>ez_search_engine_solr:
    endpoints:
        endpoint0:
            dsn: %solr_dsn%
            core: collection1
    connections:
        default:
            entry_endpoints:
                - endpoint0
            mapping:
                default: endpoint0</pre></td></tr></table><div><div class="syntaxhighlighter nogutter  php"><h4>Shared Core example</h4><p>In the following example we have decided to separate one language as the installation contains several similar languages, and one very different language that should receive proper language analysis for proper stemming and sorting behavior by Solr:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="a0d85992-0add-4388-aadf-23106aeb48a3" data-macro-parameters="title=config.yml" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1984.png?definition=e2NvZGU6dGl0bGU9Y29uZmlnLnltbH0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>ez_search_engine_solr:
    endpoints:
        endpoint0:
            dsn: %solr_dsn%
            core: core0
        endpoint1:
            dsn: %solr_dsn%
            core: core1
    connections:
        default:
            entry_endpoints:
                - endpoint0
                - endpoint1
            mapping:
                translations:
                    jpn-JP: endpoint1
                # Other languages, for instance eng-US and other western languages are sharing core
                default: endpoint0</pre></td></tr></table><h4>Multi Core example</h4><p>If full language analysis features are preferred, then each language can be configured to separate cores.</p><p><em>Note: Please make sure to test this setup against single core setup, as it might perform worse than single core if your project uses a lot of language fallbacks per siteaccess, as queries will then be performed across several cores at once.</em></p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="f414d306-cd77-4013-a827-b4a1924c200f" data-macro-parameters="title=config.yml" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading1984.png?definition=e2NvZGU6dGl0bGU9Y29uZmlnLnltbH0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>ez_search_engine_solr:
    endpoints:
        endpoint0:
            dsn: %solr_dsn%
            core: core0
        endpoint1:
            dsn: %solr_dsn%
            core: core1
        endpoint2:
            dsn: %solr_dsn%
            core: core2
        endpoint3:
            dsn: %solr_dsn%
            core: core3
        endpoint4:
            dsn: %solr_dsn%
            core: core4
        endpoint5:
            dsn: %solr_dsn%
            core: core5
        endpoint6:
            dsn: %solr_dsn%
            core: core6
    connections:
        default:
            entry_endpoints:
                - endpoint0
                - endpoint1
                - endpoint2
                - endpoint3
                - endpoint4
                - endpoint5
                - endpoint6
            mapping:
                translations:
                    - jpn-JP: endpoint1
                    - eng-US: endpoint2
                    - fre-FR: endpoint3
                    - ger-DE: endpoint4
                    - esp-ES: endpoint5
                # Not really used, but specified here for fallback if more languages are suddenly added by content admins
                default: endpoint0
                # Also use separate core for main languages (differs from content object to content object)
                # This is useful to reduce number of cores queried for always available language fallbacks
                main_translations: endpoint6</pre></td></tr></table><p><em> </em></p></div></div><h3>Step 4: Configuring repository with the specific search engine</h3><p><span>The following is an example of configuring Solr Search Engine, where <code>connection</code> name is same as in example above, and engine is set to </span> <code>solr</code>:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="52089f8c-d7aa-4765-9be5-d818b3d8fe82" data-macro-parameters="title=ezplatform.yml" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-headingfc7c.png?definition=e2NvZGU6dGl0bGU9ZXpwbGF0Zm9ybS55bWx9&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>exponential:
    repositories:
        default:
            storage: ~
            search:
                engine: %search_engine%
                connection: default</pre></td></tr></table><div class="syntaxhighlighter nogutter  php"><p><code>%search_engine%</code> is a parameter that is configured in <code>app/config/parameters.yml</code>, and should be changed from its default value &quot;<code>legacy</code>&quot; to &quot;<code>solr</code>&quot; to activate Solr as the Search engine.</p></div><h3>Step 5: Clear prod cache</h3><p>While Symfony dev environment keeps track of changes to yml files, prod does not, so to make sure Symfony reads the new config we clear cache:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="7e252176-9495-4fbc-8ff6-d5aa775493c7" data-macro-parameters="language=bash" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading174f.png?definition=e2NvZGU6bGFuZ3VhZ2U9YmFzaH0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>php app/console --env=prod clear:cache</pre></td></tr></table><h3>Step 6: Run CLI indexing command</h3><table class="wysiwyg-macro" data-macro-name="info" data-macro-id="b0c1aba1-aca3-4a07-9976-25abcadb0cd7" data-macro-parameters="title=Make sure to configure your setup for indexing" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading0eba.png?definition=e2luZm86dGl0bGU9TWFrZSBzdXJlIHRvIGNvbmZpZ3VyZSB5b3VyIHNldHVwIGZvciBpbmRleGluZ30&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="RICH_TEXT"><tr><td class="wysiwyg-macro-body"><p>Some exceptions might happen on indexing if you have not configured your setup correctly, here are the most common issues you may encounter:</p><ul><li>Exception if Binary files in database have an invalid path prefix<ul><li>Make sure <code>ezplatform.yml</code> configuration <span> <span> <code>var_dir</code> is configured properly.</span> </span></li><li><span> <span>If your database is inconsistent in regards to file paths, try to update entries to be correct <em>(but make sure to make a backup first)</em>.</span> </span></li></ul></li><li>Exception<span> on unsupported Field Types</span><ul><li><span>Make sure to implement all Field Types in your installation, or to configure missing ones as <a class="confluence-link" href="../../display/DEVELOPER/Null%2bField%2bType.html" data-linked-resource-id="31430527" data-linked-resource-version="2" data-linked-resource-type="page" data-linked-resource-default-alias="Null Field Type" data-base-url="../../index.html"> <span class="confluence-link">NullType</span> </a>if implementation is not needed.</span></li></ul></li><li><span>Content not immediately available </span><ul><li><span>Solr Bundle is on purpose not committing changes directly on Repository updates <em>(on indexing)</em>, but letting you control this using Solr configuration. </span> <span>Adjust Solr</span> <strong>autoSoftCommit </strong> <em>visibility of change to search index)</em> <span> and/or <strong>autoCommit</strong> <em>(hard commit, for durability and replication) </em>to balance performance and load on your Solr instance against needs you have for &quot;<a class="external-link" href="https://cwiki.apache.org/confluence/display/solr/Near+Real+Time+Searching" rel="nofollow">NRT</a>&quot;.</span></li></ul></li><li>Running out of memory during indexing<ul><li>In general <span>make sure to run indexing using prod environment to avoid debuggers and loggers from filing up memory.</span></li><li class="confluence-link">Stash: Disable in_memory cache as recommended on <a class="confluence-link" href="../../display/DEVELOPER/Repository.html#Repository-PersistenceCache" data-anchor="PersistenceCache" data-linked-resource-id="31432023" data-linked-resource-version="48" data-linked-resource-type="page" data-linked-resource-default-alias="Repository#PersistenceCache" data-base-url="../../index.html">Persistence cache</a> for long running scripts.</li><li>Flysystem: An open issue exists where you can find further info <a href="https://jira.ez.no/browse/EZP-25325" style="line-height: 1.42857;">https://jira.ez.no/browse/EZP-25325</a></li></ul></li></ul></td></tr></table><p>Last step is to execute initial indexation of data:</p><table class="wysiwyg-macro" data-macro-name="code" data-macro-id="44481a50-bde7-4273-8dff-93bbef2c3ec3" data-macro-parameters="language=bash" data-macro-schema-version="1" style="background-image: url(../servlet/confluence/placeholder/macro-heading174f.png?definition=e2NvZGU6bGFuZ3VhZ2U9YmFzaH0&amp;locale=en_GB&amp;version=2); background-repeat: no-repeat;" data-macro-body-type="PLAIN_TEXT"><tr><td class="wysiwyg-macro-body"><pre>php app/console --env=prod --siteaccess=&lt;name> ezplatform:solr_create_index</pre></td></tr></table><h2>Providing feedback</h2><p>After completing the installation you are now free to use your site as usual. If you get any exceptions for missing features, have feedback on performance, or want to discuss, join our community slack channel at <a href="https://ezcommunity.slack.com/messages/ezplatform-use/">https://ezcommunity.slack.com/messages/ezplatform-use/</a></p><p> </p></div>
</div>
<div class="cell aside" data-type="aside">
<div class="innerCell">
<h4>In this topic:</h4><p><img class="editor-inline-macro" src="../servlet/confluence/placeholder/macro7c73.png?definition=e3RvYzptYXhMZXZlbD0zfQ&amp;locale=en_GB&amp;version=2" data-macro-name="toc" data-macro-id="e9ea8711-29bc-4c09-a66f-4c3cb3ef0fb1" data-macro-parameters="maxLevel=3" data-macro-schema-version="1"></p></div>
</div>
</div>
</div>
        <p>&nbsp;</p>
    </body>

<!-- Mirrored from doc.ez.no/plugins/viewsource/viewpagesrc.action?pageId=32114390 by HTTrack Website Copier/3.x [XR&CO'2013], Wed, 01 Feb 2017 02:56:40 GMT -->
</html>
